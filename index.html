<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="慧助手 - 您的数字伙伴，提供智能对话服务">
    <title>慧助手 - 登录</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Noto Sans SC', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #8b5cf6;
            
            --bg-dark: #0f172a;
            --bg-darker: #1e293b;
            --bg-light: #f8fafc;
            --bg-lighter: #ffffff;
            
            --text-dark: #1e293b;
            --text-light: #f1f5f9;
            --text-muted: #94a3b8;
            --text-muted-dark: #64748b;
            
            --border-light: #e2e8f0;
            --border-dark: #334155;
            
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
        }
        
        /* 登录页面背景 */
        .login-bg {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
        }
        
        /* 登录卡片样式 */
        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            max-width: 1200px;
            width: 90%;
        }
        
        /* 左侧背景区域 */
        .login-left {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: 60px 40px;
        }
        
        .login-left h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .login-left p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 40px;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            font-size: 1rem;
        }
        
        .feature-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        /* 右侧登录表单 */
        .login-right {
            padding: 60px 50px;
        }
        
        .login-right h2 {
            font-size: 2rem;
            color: var(--text-dark);
            margin-bottom: 40px;
            text-align: center;
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-light);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            color: var(--text-dark);
        }
        
        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }
        
        /* 记住我和忘记密码 */
        .form-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .remember-me {
            display: flex;
            align-items: center;
            color: var(--text-muted-dark);
        }
        
        .forgot-password {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        
        .forgot-password:hover {
            text-decoration: underline;
        }
        
        /* 登录按钮 */
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .divider {
            display: flex;
            align-items: center;
            margin: 30px 0;
            color: var(--text-muted);
        }
        
        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-light);
        }
        
        .divider span {
            padding: 0 15px;
        }
        
        /* 社交登录 */
        .social-login {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .social-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--border-light);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .social-btn:hover {
            border-color: var(--primary-color);
            transform: translateY(-3px);
        }
        
        .social-btn.wechat {
            color: #09bb07;
        }
        
        .social-btn.qq {
            color: #12b7f5;
        }
        
        /* 注册链接 */
        .register-link {
            text-align: center;
            color: var(--text-muted);
        }
        
        .register-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }
        
        .register-link a:hover {
            text-decoration: underline;
        }
        
        /* 错误提示 */
        .error-message {
            color: var(--error);
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }
        
        /* 响应式设计 */
        @media (max-width: 992px) {
            .login-card {
                flex-direction: column;
            }
            
            .login-left {
                padding: 40px 30px;
            }
            
            .login-right {
                padding: 40px 30px;
            }
        }
        
        @media (max-width: 576px) {
            .login-left {
                padding: 30px 20px;
            }
            
            .login-right {
                padding: 30px 20px;
            }
            
            .login-left h1 {
                font-size: 2rem;
            }
            
            .login-right h2 {
                font-size: 1.5rem;
            }
        }
        
        body {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .glass-effect {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .knowledge-card {
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-dark);
        }
        
        .knowledge-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.2);
            border-color: var(--primary-color);
        }
        
        .nav-link {
            position: relative;
            transition: all 0.3s ease;
            color: var(--text-light);
        }
        
        .nav-link:hover {
            color: var(--primary-color);
        }
        
        .nav-link.active {
            color: var(--primary-color);
        }
        
        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 1px;
        }
        
        .ai-avatar {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 50%;
            animation: float 3s ease-in-out infinite;
        }
        
        .chat-bubble {
            animation: fadeInUp 0.3s ease-out;
            position: relative;
            margin-bottom: 1.25rem;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .ai-bubble {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15));
            border-radius: 1.125rem 1.125rem 1.125rem 0;
            padding: 0.875rem 1.125rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s ease;
            max-width: 85%;
            margin-right: auto;
        }
        
        .user-bubble {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 1.125rem 1.125rem 0 1.125rem;
            padding: 0.875rem 1.125rem;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.25);
            transition: transform 0.2s ease;
            max-width: 85%;
            margin-left: auto;
            color: white;
        }
        
        .message-container {
            max-height: 65vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.1);
            scroll-behavior: smooth;
            padding: 0.5rem;
        }
        
        .message-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .message-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }
        
        .message-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            animation: typing 1.4s infinite both;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .pulse-ring {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.3);
            animation: pulseRing 1.5s infinite ease-out;
            pointer-events: none;
        }
        
        @keyframes pulseRing {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .message-container {
                max-height: 55vh;
            }
            
            .ai-bubble, .user-bubble {
                max-width: 90%;
            }
        }
        
        @media (max-width: 480px) {
            .message-container {
                max-height: 50vh;
            }
        }
        
        /* 工具提示 */
        .tooltip {
            position: relative;
        }
        
        .tooltip:hover::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 12px;
            background: var(--bg-darker);
            color: var(--text-light);
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
            margin-bottom: 8px;
            border: 1px solid var(--border-dark);
        }
        
        /* 加载动画 */
        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 消息操作按钮 */
        .message-actions {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .ai-bubble:hover .message-actions,
        .user-bubble:hover .message-actions {
            opacity: 1;
        }
        
        /* 粒子效果 */
        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: floatParticle 20s infinite linear;
        }
        
        @keyframes floatParticle {
            0% {
                transform: translateY(100vh) rotate(0deg);
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
            }
        }
        
        /* 输入框自动增长 */
        .auto-grow {
            resize: none;
            overflow: hidden;
            min-height: 44px;
            max-height: 150px;
        }
        
        /* 主题切换过渡 */
        .theme-transition {
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        /* 通知动画 */
        .notification {
            animation: slideInDown 0.3s ease-out;
        }
        
        @keyframes slideInDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* 设置模态框样式 */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* 系统提示词输入框样式 */
        .system-prompt-input {
            font-family: 'Courier New', monospace;
            line-height: 1.5;
        }
        
        /* 预设标签样式 */
        .preset-tag {
            transition: all 0.2s ease;
            cursor: pointer;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-dark);
        }
        
        .preset-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            border-color: var(--primary-color);
        }
        
        /* 提示词预览区域 */
        .preview-area {
            border-left: 3px solid var(--primary-color);
            background: rgba(30, 41, 59, 0.3);
        }
        
        /* 消息反馈样式 */
        .message-feedback {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        
        .feedback-btn {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.6);
        }
        
        .feedback-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .feedback-btn.liked {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .feedback-btn.disliked {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        /* 消息编辑样式 */
        .message-editor {
            display: none;
            margin-top: 8px;
        }
        
        .message-edit-input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-dark);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
            max-height: 200px;
        }
        
        .message-edit-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }
        
        .message-edit-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .message-edit-btn {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .message-edit-btn.save {
            background: var(--primary-color);
            color: white;
            border: none;
        }
        
        .message-edit-btn.save:hover {
            background: var(--accent-color);
        }
        
        .message-edit-btn.cancel {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--border-dark);
        }
        
        .message-edit-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* 用户消息操作按钮 */
        .user-message-actions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            justify-content: flex-end;
        }
        
        .user-action-btn {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: none;
        }
        
        .user-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .user-action-btn.edit {
            background: rgba(102, 126, 234, 0.2);
            color: var(--primary-color);
        }
        
        .user-action-btn.edit:hover {
            background: rgba(102, 126, 234, 0.3);
        }
        
        /* 消息操作按钮样式 */
        .action-btn {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .action-btn.copy {
            background: rgba(139, 92, 246, 0.2);
            color: var(--accent-color);
        }
        
        .action-btn.copy:hover {
            background: rgba(139, 92, 246, 0.3);
        }
        
        .action-btn.regenerate {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }
        
        .action-btn.regenerate:hover {
            background: rgba(34, 197, 94, 0.3);
        }
        
        html, body {
            overflow-x: hidden;
            width: 100%;
            position: relative;
        }
        
        /* 侧边栏容器样式- 修复版 */
        #sidebar-container {
            position: relative;
            flex-shrink: 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
            transform-origin: left center;
            width: 280px;
            min-width: 280px;
            max-width: 280px;
        }
        
        /* 侧边栏样式 - 修复版 */
        #sidebar {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            height: calc(100vh - 140px);
            position: sticky;
            top: 100px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            will-change: transform, opacity;
            transform-origin: left center;
            transform: scaleX(1);
            opacity: 1;
            visibility: visible;
        }
        
        /* 侧边栏收起状态 - 修复版 */
        #sidebar.collapsed {
            transform: scaleX(0);
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            width: 0;
            min-width: 0;
            padding: 0;
            margin: 0;
            border: none;
        }
        
        /* 侧边栏容器收起状态 - 修复版 */
        #sidebar-container.collapsed {
            width: 0;
            min-width: 0;
            max-width: 0;
            margin: 0;
        }
        
        /* 聊天区域自适应 - 修复版 */
        #chat-area {
            flex: 1;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 0;
            width: 100%;
        }
        
        /* 聊天网格容器 - 修复版 */
        #chat-grid-container {
            display: flex;
            gap: 1.5rem;
            min-height: calc(100vh - 140px);
            position: relative;
            width: 100%;
        }
        
        /* 侧边栏切换按钮 - 修复版 */
        .sidebar-toggle-btn {
            position: absolute;
            right: -12px;
            top: 20px;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            color: white;
            will-change: transform;
        }
        
        .sidebar-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .sidebar-toggle-btn i {
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        
        /* 收起时的按钮方向 */
        .sidebar-toggle-btn.collapsed i {
            transform: rotate(180deg);
        }
        
        /* 响应式设计 - 修复版 */
        @media (max-width: 768px) {
            #chat-grid-container {
                flex-direction: column;
            }
            
            #sidebar-container {
                position: fixed;
                left: 0;
                top: 80px;
                bottom: 20px;
                z-index: 40;
                width: 100%;
                max-width: 320px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            #sidebar-container.active {
                transform: translateX(0);
            }
            
            #sidebar {
                position: relative;
                width: 100%;
                height: 100%;
                max-width: 320px;
                min-width: 320px;
                transform: none;
                opacity: 1;
                visibility: visible;
            }
            
            #sidebar.collapsed {
                transform: none;
                opacity: 1;
                visibility: visible;
            }
            
            .sidebar-toggle-btn {
                display: none;
            }
            
            /* 移动端遮罩 */
            #mobile-sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 39;
                display: none;
            }
            
            #mobile-sidebar-overlay.active {
                display: block;
            }
            
            /* 移动端聊天区域全宽 */
            #chat-area {
                width: 100%;
            }
            
            #sidebar-container.collapsed {
                width: 0;
                max-width: 0;
            }
        }
        
        @media (min-width: 769px) {
            #mobile-commands-btn {
                display: none;
            }
        }
        
        /* 侧边栏滚动条 */
        #sidebar::-webkit-scrollbar {
            width: 4px;
        }
        
        #sidebar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
        }
        
        #sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }
        
        #sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* 修复滚动条引起的布局抖动 */
        .scrollbar-fix {
            scrollbar-gutter: stable;
        }
        
        /* 修复页面加载时的抖动 */
        body.loaded {
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        
        body:not(.loaded) {
            opacity: 0;
        }
        
        .task-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-dark);
            border-radius: 1rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            border-color: var(--primary-color);
        }
        
        .task-card.completed {
            opacity: 0.7;
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }
        
        .task-card.important {
            border-left: 4px solid var(--error);
        }
        
        .task-card.in-progress {
            border-left: 4px solid var(--warning);
        }
        
        .task-card.planned {
            border-left: 4px solid var(--info);
        }
        
        .task-priority {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }
        
        .priority-high {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }
        
        .priority-medium {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }
        
        .priority-low {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }
        
        .task-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(102, 126, 234, 0.15);
            color: var(--primary-color);
            border-radius: 1rem;
            font-size: 0.75rem;
            margin-right: 0.5rem;
            margin-bottom: 0.25rem;
        }
        
        .task-progress {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 0.75rem 0;
        }
        
        .task-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .task-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .task-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .task-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }
        
        .task-checkbox.checked i {
            color: white;
            font-size: 12px;
        }
        
        .task-checkbox:hover {
            border-color: var(--success);
            transform: scale(1.1);
        }
        
        .task-actions {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .task-card:hover .task-actions {
            opacity: 1;
        }
        
        .task-action-btn {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.6);
        }
        
        .task-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .task-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }
        
        .task-action-btn.edit:hover {
            background: rgba(102, 126, 234, 0.2);
            color: var(--primary-color);
        }
        
        .task-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .task-filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-dark);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }
        
        .task-filter-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .task-filter-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border-color: transparent;
        }
        
        .task-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-dark);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .task-modal {
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .task-modal .form-group {
            margin-bottom: 1.5rem;
        }
        
        .task-modal label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .task-modal input,
        .task-modal textarea,
        .task-modal select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-dark);
            border-radius: 0.75rem;
            color: var(--text-light);
            font-size: 0.875rem;
        }
        
        .task-modal input:focus,
        .task-modal textarea:focus,
        .task-modal select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .task-modal textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .date-input {
            position: relative;
        }
        
        .date-input i {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }
        
        .color-picker {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 0 2px var(--border-dark);
        }
        
        /* 移动端任务样式 */
        @media (max-width: 768px) {
            .task-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-number {
                font-size: 2rem;
            }
        }
        
        @media (max-width: 480px) {
            .task-stats {
                grid-template-columns: 1fr;
            }
        }
        
        /* 任务页面动画 */
        .task-fade-in {
            animation: taskFadeIn 0.3s ease-out;
        }
        
        @keyframes taskFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .task-check-animation {
            animation: taskCheck 0.3s ease-out;
        }
        
        @keyframes taskCheck {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }
        
        /* 拖拽排序样式 */
        .task-card.dragging {
            opacity: 0.5;
            transform: scale(0.98);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .task-card.drag-over {
            border: 2px dashed var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }
        
        /* 进度动画 */
        .progress-animation {
            animation: progressFill 1s ease-out;
        }
        
        @keyframes progressFill {
            from {
                width: 0;
            }
        }
        
        .knowledge-page {
            min-height: calc(100vh - 80px);
        }
        
        .knowledge-category-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-dark);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .knowledge-category-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.2);
            border-color: var(--primary-color);
        }
        
        .knowledge-category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .knowledge-category-card:hover::before {
            transform: scaleX(1);
        }
        
        .category-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .knowledge-item-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-dark);
            border-radius: 1rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .knowledge-item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            border-color: var(--primary-color);
        }
        
        .knowledge-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        
        .knowledge-item-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .knowledge-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(102, 126, 234, 0.15);
            color: var(--primary-color);
            border-radius: 1rem;
            font-size: 0.75rem;
        }
        
        .knowledge-search-box {
            position: relative;
            margin-bottom: 2rem;
        }
        
        .knowledge-search-input {
            width: 100%;
            padding: 1rem 1.5rem 1rem 3rem;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-dark);
            border-radius: 1rem;
            color: var(--text-light);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .knowledge-search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .knowledge-search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }
        
        .knowledge-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .knowledge-filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-dark);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }
        
        .knowledge-filter-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .knowledge-filter-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border-color: transparent;
        }
        
        .knowledge-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .knowledge-content {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 0.75rem;
            border-left: 3px solid var(--primary-color);
        }
        
        .knowledge-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .knowledge-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }
        
        .knowledge-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .knowledge-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .knowledge-item-card:hover .knowledge-actions {
            opacity: 1;
        }
        
        .knowledge-action-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .knowledge-action-btn.primary {
            background: var(--primary-color);
            color: white;
        }
        
        .knowledge-action-btn.primary:hover {
            background: var(--accent-color);
        }
        
        .knowledge-action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }
        
        .knowledge-action-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .knowledge-modal {
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .knowledge-modal .form-group {
            margin-bottom: 1.5rem;
        }
        
        .knowledge-modal label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .knowledge-modal input,
        .knowledge-modal textarea,
        .knowledge-modal select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-dark);
            border-radius: 0.75rem;
            color: var(--text-light);
            font-size: 0.875rem;
        }
        
        .knowledge-modal input:focus,
        .knowledge-modal textarea:focus,
        .knowledge-modal select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .knowledge-modal textarea {
            min-height: 150px;
            resize: vertical;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
        }
        
        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .tag-input {
            flex: 1;
            min-width: 200px;
        }
        
        .tag-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .tag-suggestion {
            padding: 0.25rem 0.75rem;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-dark);
            border-radius: 1rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .tag-suggestion:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .preview-section {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 0.75rem;
            border-left: 3px solid var(--accent-color);
        }
        
        .preview-section h4 {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        /* 移动端知识库样式 */
        @media (max-width: 768px) {
            .knowledge-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .knowledge-content {
                max-height: 200px;
            }
        }
        
        @media (max-width: 480px) {
            .knowledge-stats {
                grid-template-columns: 1fr;
            }
            
            .knowledge-actions {
                opacity: 1;
            }
        }
        
        /* 知识库动画 */
        .knowledge-fade-in {
            animation: knowledgeFadeIn 0.3s ease-out;
        }
        
        @keyframes knowledgeFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* 加载动画 */
        .knowledge-loading {
            display: flex;
            justify-content: center;
            padding: 2rem;
        }
        
        .knowledge-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        .account-avatar {
            position: relative;
            display: inline-block;
        }
        
        .account-avatar-edit {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 28px;
            height: 28px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
        }
        
        .account-avatar:hover .account-avatar-edit {
            opacity: 1;
        }
        
        .account-avatar-edit i {
            color: white;
            font-size: 12px;
        }
        
        .form-section {
            background: rgba(30, 41, 59, 0.4);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .form-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary-color);
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .password-strength {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .password-strength-bar {
            height: 100%;
            width: 0;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .password-strength-text {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            text-align: right;
        }
        
        .account-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .account-stat-item {
            background: rgba(30, 41, 59, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
            transition: transform 0.2s ease;
        }
        
        .account-stat-item:hover {
            transform: translateY(-2px);
            background: rgba(30, 41, 59, 0.5);
        }
        
        .account-stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }
        
        .account-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            border: 1px solid rgba(148, 163, 184, 0.1);
            transition: all 0.2s ease;
        }
        
        .session-item:hover {
            background: rgba(30, 41, 59, 0.5);
            border-color: var(--primary-color);
        }
        
        .session-item.current {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }
        
        .session-info {
            flex: 1;
        }
        
        .session-info h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }
        
        .session-details {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .session-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .danger-zone {
            border: 1px solid var(--error);
            background: rgba(239, 68, 68, 0.05);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .danger-zone h3 {
            color: var(--error) !important;
            border-bottom: 1px solid rgba(239, 68, 68, 0.2) !important;
        }
        
        .danger-zone .btn-danger {
            background: linear-gradient(135deg, var(--error), #dc2626);
            color: white;
            border: none;
        }
        
        .danger-zone .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        
        /* 移动端账户设置样式 */
        @media (max-width: 768px) {
            .account-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .session-item {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .session-actions {
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .account-stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* 账户设置动画 */
        .account-fade-in {
            animation: accountFadeIn 0.3s ease-out;
        }
        
        @keyframes accountFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- 粒子背景 -->
    <div id="particle-container" class="particle-bg"></div>
    
    <!-- 登录页面 -->
    <div id="login-page" class="login-bg min-h-screen flex items-center justify-center p-4">
        <div class="login-card flex flex-col md:flex-row shadow-2xl">
            <!-- 左侧背景和介绍 -->
            <div class="login-left md:w-1/2">
                <h1>欢迎回到慧助手</h1>
                <p>登录您的账户，体验智能对话，获取个性化AI服务，享受专属功能特权。</p>
                
                <div class="features-list">
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fa fa-bolt"></i>
                        </div>
                        <span>智能对话与问题解答</span>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fa fa-code"></i>
                        </div>
                        <span>编程支持与代码优化</span>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fa fa-book"></i>
                        </div>
                        <span>学习指导与知识问答</span>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fa fa-cogs"></i>
                        </div>
                        <span>个性化设置与账户管理</span>
                    </div>
                </div>
            </div>
            
            <!-- 右侧登录表单 -->
            <div class="login-right md:w-1/2">
                <h2>用户登录</h2>
                
                <form id="login-form">
                    <div class="form-group">
                        <label class="form-label">用户名/手机号/邮箱</label>
                        <input 
                            type="text" 
                            id="login-username" 
                            class="form-input"
                            placeholder="用户名、手机号或邮箱（支持中英文数字）"
                            required
                        >
                        <div id="username-error" class="error-message">用户名长度至少3位</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">密码</label>
                        <input 
                            type="password" 
                            id="login-password" 
                            class="form-input"
                            placeholder="密码（至少6位字符）"
                            required
                        >
                        <div id="password-error" class="error-message">密码长度至少6位</div>
                    </div>
                    
                    <div class="form-options">
                        <label class="remember-me">
                            <input type="checkbox" id="remember-me">
                            <span>记住我</span>
                        </label>
                        <a href="#" class="forgot-password" id="forgot-password-link">忘记密码？</a>
                    </div>
                    
                    <button type="submit" class="login-btn">
                        <span id="login-btn-text">登录</span>
                        <div id="login-loader" class="loader hidden ml-2 inline-block"></div>
                    </button>
                </form>
                
                <div class="divider">
                    <span>或使用其他方式登录</span>
                </div>
                
                <div class="social-login">
                    <div class="social-btn wechat" id="wechat-login">
                        <i class="fa fa-weixin"></i>
                    </div>
                    <div class="social-btn qq" id="qq-login">
                        <i class="fa fa-qq"></i>
                    </div>
                </div>
                
                <div class="register-link">
                    <span>还没有账户？</span>
                    <a href="#" id="register-link">立即注册</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 主应用页面（初始隐藏） -->
    <div id="main-app" class="hidden">
        <!-- 移动端菜单遮罩 -->
        <div id="mobile-overlay" class="mobile-overlay fixed inset-0 bg-black bg-opacity-30 hidden"></div>
        <!-- 移动端侧边栏遮罩 -->
        <div id="mobile-sidebar-overlay" class="hidden"></div>
        
        <!-- 顶部导航 -->
        <nav class="glass-effect fixed top-0 left-0 right-0 z-50 px-4 sm:px-6 py-4">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center">
                        <i class="fa fa-robot text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold gradient-text">慧助手</h1>
                </div>
                
                <!-- 桌面端导航 -->
                <div class="hidden lg:flex items-center space-x-6">
                    <a href="javascript:void(0)" id="chat-link" class="nav-link text-white hover:text-blue-200 px-4 py-2 rounded-lg transition-colors active">
                        <i class="fa fa-comments mr-2"></i>聊天
                    </a>
                    <a href="javascript:void(0)" id="tasks-link" class="nav-link text-white hover:text-blue-200 px-4 py-2 rounded-lg transition-colors">
                        <i class="fa fa-tasks mr-2"></i>任务
                    </a>
                    <a href="javascript:void(0)" id="knowledge-link" class="nav-link text-white hover:text-blue-200 px-4 py-2 rounded-lg transition-colors">
                        <i class="fa fa-book mr-2"></i>知识库
                    </a>
                    <a href="javascript:void(0)" id="account-link" class="nav-link text-white hover:text-blue-200 px-4 py-2 rounded-lg transition-colors">
                        <i class="fa fa-user mr-2"></i>账户
                    </a>
                    <a href="javascript:void(0)" id="settings-link" class="nav-link text-white hover:text-blue-200 px-4 py-2 rounded-lg transition-colors">
                        <i class="fa fa-cog mr-2"></i>设置
                    </a>
                </div>
                
                <!-- 用户信息和菜单按钮 -->
                <div class="flex items-center space-x-2">
                    <div id="user-info" class="hidden lg:flex items-center space-x-2 mr-2">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white font-medium text-sm">
                            <span id="user-avatar">U</span>
                        </div>
                        <span class="text-white text-sm" id="username-display">用户</span>
                    </div>
                    <button id="theme-toggle" class="p-2 rounded-lg hover:bg-slate-700 transition-colors btn tooltip" data-tooltip="切换主题">
                        <i class="fa fa-moon text-xl"></i>
                    </button>
                    <button id="settings-btn" class="p-2 rounded-lg hover:bg-slate-700 transition-colors btn tooltip" data-tooltip="AI设置">
                        <i class="fa fa-sliders text-xl"></i>
                    </button>
                    <button id="logout-btn" class="p-2 rounded-lg hover:bg-slate-700 transition-colors btn tooltip" data-tooltip="退出登录">
                        <i class="fa fa-sign-out text-xl"></i>
                    </button>
                    <button id="mobile-menu-btn" class="lg:hidden p-2 rounded-lg hover:bg-slate-700 transition-colors btn">
                        <i class="fa fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- 移动端菜单 -->
            <div id="mobile-menu" class="mobile-menu lg:hidden fixed top-0 left-0 bottom-0 w-64 bg-slate-800 z-50 p-6 translate-x-[-100%] transition-transform duration-300">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-lg font-bold gradient-text">菜单</h2>
                    <button id="close-mobile-menu" class="p-2 rounded-lg hover:bg-slate-700 btn">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- 移动端用户信息 -->
                <div class="flex items-center space-x-3 mb-6 p-3 rounded-lg bg-slate-700/50">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white font-medium">
                        <span id="mobile-user-avatar">U</span>
                    </div>
                    <div>
                        <div class="font-medium text-white" id="mobile-username-display">用户</div>
                        <div class="text-xs text-slate-400">慧助手</div>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <a href="javascript:void(0)" id="mobile-chat-link" class="block p-3 rounded-lg bg-slate-700 text-white hover-lift flex items-center">
                        <i class="fa fa-comments-o mr-3"></i>聊天
                    </a>
                    <a href="javascript:void(0)" id="mobile-tasks-link" class="block p-3 rounded-lg hover:bg-slate-700 text-white hover-lift flex items-center">
                        <i class="fa fa-tasks mr-3"></i>任务
                    </a>
                    <a href="javascript:void(0)" id="mobile-knowledge-link" class="block p-3 rounded-lg hover:bg-slate-700 text-white hover-lift flex items-center">
                        <i class="fa fa-book mr-3"></i>知识库
                    </a>
                    <a href="javascript:void(0)" id="mobile-account-link" class="block p-3 rounded-lg hover:bg-slate-700 text-white hover-lift flex items-center">
                        <i class="fa fa-user mr-3"></i>账户
                    </a>
                    <a href="javascript:void(0)" id="mobile-settings-link" class="block p-3 rounded-lg hover:bg-slate-700 text-white hover-lift flex items-center">
                        <i class="fa fa-cog mr-3"></i>设置
                    </a>
                </div>
                
                <div class="mt-8 pt-6 border-t border-slate-700">
                    <a href="javascript:void(0)" id="mobile-logout-link" class="block p-3 rounded-lg hover:bg-slate-700 text-white hover-lift flex items-center">
                        <i class="fa fa-sign-out mr-3"></i>退出登录
                    </a>
                    <div class="flex items-center justify-between p-3">
                        <span class="text-slate-400">深色模式</span>
                        <label class="switch">
                            <input type="checkbox" id="mobile-theme-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- 主要内容区域 - 聊天页面 -->
        <main id="chat-page" class="pt-20 pb-8 px-4 sm:px-6">
            <div class="max-w-7xl mx-auto">
                <div id="chat-grid-container" class="min-h-screen">
                    <!-- 左侧快捷指令面板 -->
                    <div id="sidebar-container">
                        <!-- 侧边栏切换按钮 -->
                        <div id="sidebar-toggle" class="sidebar-toggle-btn">
                            <i class="fa fa-chevron-left"></i>
                        </div>
                        
                        <div id="sidebar" class="glass-effect rounded-2xl p-6 h-full">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-lg font-semibold text-blue-300">快捷指令</h3>
                                <button id="new-chat-btn" class="text-sm px-3 py-1.5 rounded-lg bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 transition-all btn">
                                    <i class="fa fa-plus mr-1"></i>新对话
                                </button>
                            </div>
                            
                            <!-- 快捷指令列表 -->
                            <div id="quick-commands-list" class="space-y-3">
                                <!-- 通过JS动态生成 -->
                            </div>
                            
                            <!-- 对话历史 -->
                            <div class="mt-8 pt-6 border-t border-slate-700">
                                <h4 class="font-medium mb-4 text-slate-300">最近对话</h4>
                                <div id="chat-history" class="space-y-2">
                                    <!-- 通过JS动态生成 -->
                                </div>
                            </div>
                            
                            <!-- 使用统计 -->
                            <div class="mt-8 pt-6 border-t border-slate-700">
                                <h4 class="font-medium mb-4 text-slate-300">使用统计</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-slate-400">今日对话</span>
                                        <span id="today-count" class="text-sm font-medium">0</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-slate-400">本周对话</span>
                                        <span id="week-count" class="text-sm font-medium">0</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-slate-400">总对话数</span>
                                        <span id="total-count" class="text-sm font-medium">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 中央聊天区域 -->
                    <div id="chat-area" class="glass-effect rounded-2xl h-full flex flex-col">
                        <!-- 聊天头部 -->
                        <div class="p-4 sm:p-6 border-b border-slate-700">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center">
                                        <i class="fa fa-robot text-2xl text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-lg" id="current-chat-title">慧助手</h3>
                                        <p id="status-text" class="text-sm text-slate-400 flex items-center">
                                            <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                                            在线 • 准备就绪
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <button id="sidebar-toggle-mobile" class="lg:hidden p-2 rounded-lg hover:bg-slate-700 transition-colors btn tooltip" data-tooltip="快捷指令">
                                        <i class="fa fa-list-ul"></i>
                                    </button>
                                    <button id="export-chat-btn" class="p-2 rounded-lg hover:bg-slate-700 transition-colors btn tooltip" data-tooltip="导出对话">
                                        <i class="fa fa-download"></i>
                                    </button>
                                    <button id="clear-chat-btn" class="p-2 rounded-lg hover:bg-slate-700 transition-colors btn tooltip" data-tooltip="清空对话">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                    <button id="voice-toggle" class="p-2 rounded-lg hover:bg-slate-700 transition-colors btn tooltip" data-tooltip="语音设置">
                                        <i class="fa fa-volume-up"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 消息显示区域 -->
                        <div id="chat-messages" class="message-container flex-1 p-4 sm:p-6">
                            <!-- 欢迎消息 -->
                            <div class="chat-bubble">
                                <div class="ai-bubble">
                                    <p class="text-sm">👋 你好！我是你的慧助手，很高兴为你服务。我可以帮助你完成各种任务，包括：</p>
                                    <ul class="mt-2 space-y-1 text-sm text-slate-300">
                                        <li>• 回答问题和提供建议</li>
                                        <li>• 协助写作和翻译</li>
                                        <li>• 编程和技术支持</li>
                                        <li>• 学习指导和规划</li>
                                        <li>• 日常问题解答</li>
                                    </ul>
                                    <p class="mt-2 text-sm">请随时向我提问，我会尽力为你提供最优质的帮助！</p>
                                </div>
                                <div class="message-time mt-2 flex items-center">
                                    <i class="fa fa-clock-o text-xs mr-1"></i>
                                    <span>刚刚</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 输入区域 -->
                        <div class="p-4 sm:p-6 border-t border-slate-700">
                            <div class="flex items-end space-x-3">
                                <div class="flex-1 relative">
                                    <textarea 
                                        id="message-input" 
                                        placeholder="输入你的问题或指令...（按Enter发送，Shift+Enter换行）" 
                                        class="message-input w-full text-white auto-grow bg-slate-800/50 border border-slate-700 rounded-xl p-4 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all"
                                        rows="1"
                                        aria-label="消息输入框"
                                    ></textarea>
                                    <div class="absolute bottom-2 right-2 text-xs text-slate-500">
                                        <span id="char-count">0/1000</span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button id="voice-btn" class="voice-btn btn w-12 h-12 rounded-full bg-slate-800/50 border border-slate-700 hover:bg-slate-700/50 transition-all flex items-center justify-center relative" aria-label="语音输入">
                                        <i class="fa fa-microphone text-lg"></i>
                                        <div id="pulse-ring" class="pulse-ring hidden"></div>
                                    </button>
                                    <button id="send-btn" class="send-btn btn w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 transition-all flex items-center justify-center" aria-label="发送消息">
                                        <i class="fa fa-paper-plane text-lg"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 快捷指令 -->
                            <div class="mt-4 flex flex-wrap gap-2">
                                <button class="quick-command px-3 py-1.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm hover:bg-slate-700/50 transition-all hover:scale-105 active:scale-95" data-command="帮我写一封感谢邮件">
                                    ✍️ 写一封邮件
                                </button>
                                <button class="quick-command px-3 py-1.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm hover:bg-slate-700/50 transition-all hover:scale-105 active:scale-95" data-command="Python列表和元组有什么区别">
                                    💻 代码问题
                                </button>
                                <button class="quick-command px-3 py-1.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm hover:bg-slate-700/50 transition-all hover:scale-105 active:scale-95" data-command="帮我翻译这段英文">
                                    🌐 翻译文本
                                </button>
                                <button class="quick-command px-3 py-1.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm hover:bg-slate-700/50 transition-all hover:scale-105 active:scale-95" data-command="帮我制定一个学习计划">
                                    📚 学习计划
                                </button>
                            </div>
                            
                            <!-- 移动端快捷指令面板触发按钮 -->
                            <button id="mobile-commands-btn" class="lg:hidden mt-4 w-full py-3 rounded-lg bg-slate-800/50 border border-slate-700 text-sm hover:bg-slate-700/50 transition-all flex items-center justify-center">
                                <i class="fa fa-list-ul mr-2"></i> 更多快捷指令
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- 设置页面 -->
        <main id="settings-page" class="pt-20 pb-8 px-4 sm:px-6 hidden">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-3xl font-bold mb-8 text-center gradient-text">慧助手设置</h1>
                
                <div class="glass-effect rounded-xl p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-blue-300">智谱API设置</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block mb-2 text-slate-300">API Key</label>
                            <input type="password" id="settings-api-key" 
                                   class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                   placeholder="输入你的智谱API Key" value="7140e63dc45448728c5a5bc5ee349d47.bQm0yFBzpeFU8Vwa">
                            <p class="text-xs text-slate-500 mt-1">您的API Key将仅保存在本地浏览器中</p>
                        </div>
                        <div>
                            <label class="block mb-2 text-slate-300">模型选择</label>
                            <select id="settings-model-select" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                                <option value="glm-4">GLM-4（最新）</option>
                                <option value="glm-3-turbo">GLM-3-Turbo（快速）</option>
                            </select>
                        </div>
                        <button id="save-api-btn" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 rounded-lg transition-all">
                            保存API设置
                        </button>
                    </div>
                </div>
                
                <div class="glass-effect rounded-xl p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-blue-300">助手行为设置</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block mb-2 text-slate-300">系统提示词</label>
                            <textarea id="settings-system-prompt" rows="4"
                                      class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 system-prompt-input"
                                      placeholder="设置助手的角色和行为..."></textarea>
                            <p class="text-xs text-slate-500 mt-1">提示词将影响AI的回复风格和行为</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="flex items-center text-slate-300">
                                <input type="checkbox" id="settings-auto-scroll" class="mr-3 w-5 h-5 rounded">
                                自动滚动到最新消息
                            </label>
                            <label class="flex items-center text-slate-300">
                                <input type="checkbox" id="settings-voice-enabled" class="mr-3 w-5 h-5 rounded">
                                启用语音功能
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between">
                    <button id="back-to-chat-btn" class="px-6 py-3 bg-slate-800/50 border border-slate-700 hover:bg-slate-700/50 rounded-lg transition-colors">
                        <i class="fa fa-arrow-left mr-2"></i>返回聊天
                    </button>
                    <button id="reset-settings-btn" class="px-6 py-3 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 rounded-lg transition-all">
                        <i class="fa fa-refresh mr-2"></i>重置设置
                    </button>
                </div>
            </div>
        </main>
        
        <!-- 账户设置页面（新增） -->
        <main id="account-page" class="pt-20 pb-8 px-4 sm:px-6 hidden">
            <div class="max-w-5xl mx-auto">
                <h1 class="text-3xl font-bold mb-8 text-center gradient-text">账户设置</h1>
                
                <!-- 用户基本信息 -->
                <div class="form-section mb-6">
                    <h3>基本信息</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 flex flex-col items-center">
                            <div class="account-avatar mb-4">
                                <div class="w-24 h-24 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white text-3xl font-bold">
                                    <span id="account-avatar-text">U</span>
                                </div>
                                <div class="account-avatar-edit" id="avatar-edit-btn">
                                    <i class="fa fa-camera"></i>
                                </div>
                            </div>
                            <p class="text-sm text-slate-400 text-center">点击头像可修改</p>
                        </div>
                        
                        <div class="md:col-span-2">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="block mb-2 text-slate-300">用户名</label>
                                    <input type="text" id="account-username" 
                                           class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500"
                                           placeholder="输入用户名">
                                </div>
                                
                                <div class="form-group">
                                    <label class="block mb-2 text-slate-300">邮箱地址</label>
                                    <input type="email" id="account-email" 
                                           class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500"
                                           placeholder="输入邮箱地址">
                                </div>
                                
                                <div class="form-group">
                                    <label class="block mb-2 text-slate-300">手机号码</label>
                                    <input type="tel" id="account-phone" 
                                           class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500"
                                           placeholder="输入手机号码">
                                </div>
                                
                                <div class="form-group">
                                    <label class="block mb-2 text-slate-300">个性签名</label>
                                    <input type="text" id="account-bio" 
                                           class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500"
                                           placeholder="一句话介绍自己">
                                </div>
                            </div>
                            
                            <div class="form-group mt-4">
                                <label class="block mb-2 text-slate-300">个人简介</label>
                                <textarea id="account-description" rows="3"
                                          class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500"
                                          placeholder="介绍一下你自己..."></textarea>
                            </div>
                            
                            <button id="save-profile-btn" class="mt-6 px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 rounded-lg transition-all">
                                保存个人信息
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 账户统计 -->
                <div class="form-section mb-6">
                    <h3>账户统计</h3>
                    <div class="account-stats-grid">
                        <div class="account-stat-item">
                            <div class="account-stat-number" id="account-conversation-count">0</div>
                            <div class="account-stat-label">总对话数</div>
                        </div>
                        <div class="account-stat-item">
                            <div class="account-stat-number" id="account-task-count">0</div>
                            <div class="account-stat-label">总任务数</div>
                        </div>
                        <div class="account-stat-item">
                            <div class="account-stat-number" id="account-knowledge-count">0</div>
                            <div class="account-stat-label">知识条目</div>
                        </div>
                        <div class="account-stat-item">
                            <div class="account-stat-number" id="account-active-days">1</div>
                            <div class="account-stat-label">活跃天数</div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="block mb-2 text-slate-300">账户创建时间</label>
                        <div class="px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-slate-300" id="account-created-date">
                            加载中...
                        </div>
                    </div>
                </div>
                
                <!-- 密码修改 -->
                <div class="form-section mb-6">
                    <h3>修改密码</h3>
                    <div class="space-y-4">
                        <div class="form-group">
                            <label class="block mb-2 text-slate-300">当前密码</label>
                            <input type="password" id="current-password" 
                                   class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500"
                                   placeholder="输入当前密码">
                        </div>
                        
                        <div class="form-group">
                            <label class="block mb-2 text-slate-300">新密码</label>
                            <input type="password" id="new-password" 
                                   class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500"
                                   placeholder="输入新密码（至少6位字符）">
                            <div class="password-strength">
                                <div class="password-strength-bar" id="password-strength-bar"></div>
                            </div>
                            <div class="password-strength-text" id="password-strength-text">密码强度：弱</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="block mb-2 text-slate-300">确认新密码</label>
                            <input type="password" id="confirm-password" 
                                   class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-blue-500"
                                   placeholder="再次输入新密码">
                        </div>
                        
                        <button id="change-password-btn" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 rounded-lg transition-all">
                            修改密码
                        </button>
                    </div>
                </div>
                
                <!-- 会话管理 -->
                <div class="form-section mb-6">
                    <h3>登录会话</h3>
                    <div id="sessions-list">
                        <!-- 会话列表将通过JS动态生成 -->
                    </div>
                    <button id="refresh-sessions-btn" class="mt-4 px-4 py-2 bg-slate-800/50 border border-slate-700 hover:bg-slate-700/50 rounded-lg transition-colors">
                        <i class="fa fa-refresh mr-2"></i>刷新会话列表
                    </button>
                </div>
                
                <!-- 危险区域 -->
                <div class="danger-zone">
                    <h3>危险操作</h3>
                    <div class="space-y-4">
                        <div class="form-group">
                            <p class="text-slate-300 mb-3">这些操作将永久删除您的数据，请谨慎操作</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <button id="export-data-btn" class="px-4 py-3 bg-slate-800/50 border border-slate-700 hover:bg-slate-700/50 rounded-lg transition-colors">
                                    <i class="fa fa-download mr-2"></i>导出所有数据
                                </button>
                                <button id="clear-data-btn" class="px-4 py-3 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 rounded-lg transition-all">
                                    <i class="fa fa-trash mr-2"></i>清空所有数据
                                </button>
                                <button id="delete-account-btn" class="px-4 py-3 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 rounded-lg transition-all btn-danger">
                                    <i class="fa fa-user-times mr-2"></i>删除账户
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 flex justify-center">
                    <button id="back-to-chat-from-account" class="px-6 py-3 bg-slate-800/50 border border-slate-700 hover:bg-slate-700/50 rounded-lg transition-colors">
                        <i class="fa fa-arrow-left mr-2"></i>返回聊天
                    </button>
                </div>
            </div>
        </main>
        
        <!-- 任务页面（完善版） -->
        <main id="tasks-page" class="pt-20 pb-8 px-4 sm:px-6 hidden">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold gradient-text">任务管理</h1>
                    <button id="create-task-btn" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 rounded-lg transition-all">
                        <i class="fa fa-plus mr-2"></i>新建任务
                    </button>
                </div>
                
                <!-- 任务统计 -->
                <div class="task-stats mb-8">
                    <div class="stat-card">
                        <div class="stat-number" id="total-tasks-count">0</div>
                        <div class="stat-label">总任务数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completed-tasks-count">0</div>
                        <div class="stat-label">已完成</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="today-tasks-count">0</div>
                        <div class="stat-label">今日任务</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="overdue-tasks-count">0</div>
                        <div class="stat-label">已逾期</div>
                    </div>
                </div>
                
                <!-- 任务筛选 -->
                <div class="task-filters mb-6">
                    <button class="task-filter-btn active" data-filter="all">全部任务</button>
                    <button class="task-filter-btn" data-filter="today">今日</button>
                    <button class="task-filter-btn" data-filter="completed">已完成</button>
                    <button class="task-filter-btn" data-filter="pending">待完成</button>
                    <button class="task-filter-btn" data-filter="overdue">已逾期</button>
                    <button class="task-filter-btn" data-filter="important">重要</button>
                </div>
                
                <!-- 任务列表 -->
                <div id="tasks-list-container">
                    <!-- 通过JS动态生成 -->
                </div>
                
                <!-- 空状态 -->
                <div id="tasks-empty-state" class="empty-state hidden">
                    <i class="fa fa-tasks"></i>
                    <h3 class="text-xl font-medium mb-2">暂无任务</h3>
                    <p class="text-slate-400 mb-4">创建您的第一个任务来开始管理您的工作吧！</p>
                    <button id="create-first-task-btn" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 rounded-lg transition-all">
                        <i class="fa fa-plus mr-2"></i>创建第一个任务
                    </button>
                </div>
                
                <div class="mt-8 flex justify-center">
                    <button id="back-to-chat-from-tasks" class="px-6 py-3 bg-slate-800/50 border border-slate-700 hover:bg-slate-700/50 rounded-lg transition-colors">
                        <i class="fa fa-arrow-left mr-2"></i>返回聊天
                    </button>
                </div>
            </div>
        </main>
        
        <!-- 知识库页面（完整版） -->
        <main id="knowledge-page" class="knowledge-page pt-20 pb-8 px-4 sm:px-6 hidden">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold gradient-text">知识库</h1>
                    <button id="create-knowledge-btn" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 rounded-lg transition-all">
                        <i class="fa fa-plus mr-2"></i>新建知识
                    </button>
                </div>
                
                <!-- 知识库统计 -->
                <div class="knowledge-stats mb-8">
                    <div class="stat-card">
                        <div class="stat-number" id="total-knowledge-count">0</div>
                        <div class="stat-label">知识条目</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="today-knowledge-count">0</div>
                        <div class="stat-label">今日新增</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="categories-count">0</div>
                        <div class="stat-label">分类数量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="tags-count">0</div>
                        <div class="stat-label">标签数量</div>
                    </div>
                </div>
                
                <!-- 搜索框 -->
                <div class="knowledge-search-box">
                    <i class="fa fa-search knowledge-search-icon"></i>
                    <input type="text" id="knowledge-search-input" class="knowledge-search-input" placeholder="搜索知识条目...">
                </div>
                
                <!-- 知识库筛选 -->
                <div class="knowledge-filters mb-6">
                    <button class="knowledge-filter-btn active" data-filter="all">全部知识</button>
                    <button class="knowledge-filter-btn" data-filter="technology">技术</button>
                    <button class="knowledge-filter-btn" data-filter="learning">学习</button>
                    <button class="knowledge-filter-btn" data-filter="work">工作</button>
                    <button class="knowledge-filter-btn" data-filter="life">生活</button>
                    <button class="knowledge-filter-btn" data-filter="recent">最近</button>
                    <button class="knowledge-filter-btn" data-filter="favorite">收藏</button>
                </div>
                
                <!-- 知识分类 -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4 text-blue-300">知识分类</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="knowledge-category-card" data-category="technology">
                            <div class="category-icon bg-blue-500/20 text-blue-400">
                                <i class="fa fa-code"></i>
                            </div>
                            <h4 class="font-semibold text-lg mb-2">技术知识</h4>
                            <p class="text-sm text-slate-400">编程、开发、系统架构等</p>
                            <div class="mt-3 text-sm text-slate-500" id="tech-count">0 条知识</div>
                        </div>
                        <div class="knowledge-category-card" data-category="learning">
                            <div class="category-icon bg-green-500/20 text-green-400">
                                <i class="fa fa-graduation-cap"></i>
                            </div>
                            <h4 class="font-semibold text-lg mb-2">学习笔记</h4>
                            <p class="text-sm text-slate-400">学习心得、知识点总结等</p>
                            <div class="mt-3 text-sm text-slate-500" id="learning-count">0 条知识</div>
                        </div>
                        <div class="knowledge-category-card" data-category="work">
                            <div class="category-icon bg-purple-500/20 text-purple-400">
                                <i class="fa fa-briefcase"></i>
                            </div>
                            <h4 class="font-semibold text-lg mb-2">工作文档</h4>
                            <p class="text-sm text-slate-400">工作流程、项目文档等</p>
                            <div class="mt-3 text-sm text-slate-500" id="work-count">0 条知识</div>
                        </div>
                        <div class="knowledge-category-card" data-category="life">
                            <div class="category-icon bg-orange-500/20 text-orange-400">
                                <i class="fa fa-heart"></i>
                            </div>
                            <h4 class="font-semibold text-lg mb-2">生活经验</h4>
                            <p class="text-sm text-slate-400">生活技巧、经验分享等</p>
                            <div class="mt-3 text-sm text-slate-500" id="life-count">0 条知识</div>
                        </div>
                    </div>
                </div>
                
                <!-- 知识列表 -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-blue-300">所有知识条目</h3>
                        <div class="text-sm text-slate-400">
                            共 <span id="knowledge-total-count">0</span> 条知识
                        </div>
                    </div>
                    <div id="knowledge-list-container">
                        <!-- 通过JS动态生成 -->
                    </div>
                </div>
                
                <!-- 空状态 -->
                <div id="knowledge-empty-state" class="empty-state hidden">
                    <i class="fa fa-book"></i>
                    <h3 class="text-xl font-medium mb-2">暂无知识条目</h3>
                    <p class="text-slate-400 mb-4">创建您的第一个知识条目来构建个人知识库吧！</p>
                    <button id="create-first-knowledge-btn" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 rounded-lg transition-all">
                        <i class="fa fa-plus mr-2"></i>创建第一个知识
                    </button>
                </div>
                
                <div class="mt-8 flex justify-center">
                    <button id="back-to-chat-from-knowledge" class="px-6 py-3 bg-slate-800/50 border border-slate-700 hover:bg-slate-700/50 rounded-lg transition-colors">
                        <i class="fa fa-arrow-left mr-2"></i>返回聊天
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- 通知区域 -->
    <div id="notification-area" class="fixed top-20 right-4 z-50 space-y-2"></div>
    
    <!-- 移动端快捷指令模态框 -->
    <div id="mobile-commands-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/50" id="modal-overlay"></div>
        <div class="glass-effect rounded-2xl p-6 w-full max-w-md max-h-[80vh] overflow-y-auto relative">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-blue-300">快捷指令</h3>
                <button id="close-modal-btn" class="p-2 rounded-lg hover:bg-slate-700 btn">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div id="mobile-commands-list" class="space-y-4">
                <!-- 通过JS动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- AI设置模态框 -->
    <div id="ai-settings-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/50 modal-overlay" id="ai-settings-overlay"></div>
        <div class="glass-effect rounded-2xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto relative modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-blue-300">AI助手设置</h3>
                <button id="close-ai-settings-btn" class="p-2 rounded-lg hover:bg-slate-700 btn">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- API设置 -->
                <div>
                    <h4 class="font-medium mb-3 text-slate-300">API设置</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">API Key</label>
                            <input 
                                type="password" 
                                id="api-key-input" 
                                placeholder="输入您的智谱API Key" 
                                class="w-full bg-slate-800/50 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500"
                                value="7140e63dc45448728c5a5bc5ee349d47.bQm0yFBzpeFU8Vwa"
                            >
                            <p class="text-xs text-slate-500 mt-1">您的API Key将仅保存在本地浏览器中</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm text-slate-400 mb-1">模型选择</label>
                                <select id="model-select" class="w-full bg-slate-800/50 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500">
                                    <option value="glm-4">GLM-4</option>
                                    <option value="glm-3-turbo">GLM-3-Turbo</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-slate-400 mb-1">温度 (Temperature)</label>
                                <div class="flex items-center space-x-3">
                                    <input 
                                        type="range" 
                                        id="temperature-slider" 
                                        min="0" 
                                        max="1" 
                                        step="0.1" 
                                        value="0.7" 
                                        class="flex-1"
                                    >
                                    <span id="temperature-value" class="text-sm text-slate-300">0.7</span>
                                </div>
                                <p class="text-xs text-slate-500 mt-1">值越高，回答越随机；值越低，回答越确定</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 系统提示词设置 -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-medium text-slate-300">系统提示词</h4>
                        <button id="reset-prompt-btn" class="text-sm px-3 py-1 bg-slate-800/50 border border-slate-700 rounded-lg hover:bg-slate-700/50 transition-colors">
                            恢复默认
                        </button>
                    </div>
                    
                    <!-- 预设提示词 -->
                    <div class="mb-4">
                        <h5 class="text-sm text-slate-400 mb-2">预设角色</h5>
                        <div class="flex flex-wrap gap-2">
                            <div class="preset-tag px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-lg hover:bg-blue-500/20 hover:border-blue-500/50 cursor-pointer" data-preset="default">
                                <div class="text-sm font-medium text-slate-200">基础助手</div>
                                <div class="text-xs text-slate-400">友好专业的通用助手</div>
                            </div>
                            <div class="preset-tag px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-lg hover:bg-purple-500/20 hover:border-purple-500/50 cursor-pointer" data-preset="teacher">
                                <div class="text-sm font-medium text-slate-200">学习导师</div>
                                <div class="text-xs text-slate-400">耐心讲解的学习伙伴</div>
                            </div>
                            <div class="preset-tag px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-lg hover:bg-green-500/20 hover:border-green-500/50 cursor-pointer" data-preset="creative">
                                <div class="text-sm font-medium text-slate-200">创意助手</div>
                                <div class="text-xs text-slate-400">激发创意思维</div>
                            </div>
                            <div class="preset-tag px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-lg hover:bg-red-500/20 hover:border-red-500/50 cursor-pointer" data-preset="strict">
                                <div class="text-sm font-medium text-slate-200">严格专家</div>
                                <div class="text-xs text-slate-400">严谨精确的回答</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 提示词编辑 -->
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">自定义提示词</label>
                        <textarea 
                            id="system-prompt-input" 
                            rows="8"
                            placeholder="输入系统提示词，定义AI助手的角色和行为..." 
                            class="system-prompt-input w-full bg-slate-800/50 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500"
                        ></textarea>
                        <div class="flex justify-between mt-1">
                            <p class="text-xs text-slate-500">提示词将影响AI的回复风格和行为</p>
                            <span id="prompt-char-count" class="text-xs text-slate-500">0/2000</span>
                        </div>
                    </div>
                    
                    <!-- 提示词预览 -->
                    <div class="mt-4 p-4 rounded-lg preview-area">
                        <h5 class="text-sm font-medium text-slate-300 mb-2">提示词预览</h5>
                        <div id="prompt-preview" class="text-sm text-slate-400 italic">
                            当前系统提示词将显示在这里...
                        </div>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-slate-700">
                    <button id="cancel-ai-settings-btn" class="px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg hover:bg-slate-700/50 transition-colors">
                        取消
                    </button>
                    <button id="save-ai-settings-btn" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all">
                        保存设置
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 任务创建/编辑模态框 -->
    <div id="task-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/50" id="task-modal-overlay"></div>
        <div class="glass-effect rounded-2xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto relative task-modal">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-blue-300" id="task-modal-title">新建任务</h3>
                <button id="close-task-modal-btn" class="p-2 rounded-lg hover:bg-slate-700 btn">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <form id="task-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="form-group">
                        <label for="task-title">任务标题</label>
                        <input type="text" id="task-title" name="title" required 
                               placeholder="输入任务标题" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="task-priority">优先级</label>
                        <select id="task-priority" name="priority" required>
                            <option value="low">低优先级</option>
                            <option value="medium">中优先级</option>
                            <option value="high">高优先级</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group mb-6">
                    <label for="task-description">任务描述</label>
                    <textarea id="task-description" name="description" 
                              placeholder="详细描述任务内容..."></textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="form-group">
                        <label for="task-due-date">截止日期</label>
                        <div class="date-input">
                            <input type="date" id="task-due-date" name="dueDate">
                            <i class="fa fa-calendar"></i>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="task-category">任务分类</label>
                        <select id="task-category" name="category">
                            <option value="work">工作</option>
                            <option value="study">学习</option>
                            <option value="personal">个人</option>
                            <option value="health">健康</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="task-progress">进度 (%)</label>
                        <input type="range" id="task-progress" name="progress" min="0" max="100" value="0">
                        <div class="flex justify-between mt-2">
                            <span class="text-xs text-slate-400">0%</span>
                            <span id="progress-value" class="text-xs text-slate-300">0%</span>
                            <span class="text-xs text-slate-400">100%</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group mb-6">
                    <label>标签（可选）</label>
                    <input type="text" id="task-tags-input" 
                           placeholder="输入标签，用逗号分隔（如：重要，紧急，项目A）">
                    <div id="task-tags-container" class="flex flex-wrap gap-2 mt-2">
                        <!-- 动态生成标签 -->
                    </div>
                </div>
                
                <div class="form-group mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" id="task-important" name="important" class="mr-3 w-5 h-5 rounded">
                        <span class="text-slate-300">标记为重要任务</span>
                    </label>
                </div>
                
                <input type="hidden" id="task-id" name="id">
                
                <div class="flex justify-end space-x-3 pt-4 border-t border-slate-700">
                    <button type="button" id="cancel-task-btn" class="px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg hover:bg-slate-700/50 transition-colors">
                        取消
                    </button>
                    <button type="submit" id="save-task-btn" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all">
                        保存任务
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 知识创建/编辑模态框 -->
    <div id="knowledge-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/50" id="knowledge-modal-overlay"></div>
        <div class="glass-effect rounded-2xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto relative knowledge-modal">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-blue-300" id="knowledge-modal-title">新建知识</h3>
                <button id="close-knowledge-modal-btn" class="p-2 rounded-lg hover:bg-slate-700 btn">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <form id="knowledge-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="form-group">
                        <label for="knowledge-title">知识标题</label>
                        <input type="text" id="knowledge-title" name="title" required 
                               placeholder="输入知识标题" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="knowledge-category">知识分类</label>
                        <select id="knowledge-category" name="category" required>
                            <option value="technology">技术知识</option>
                            <option value="learning">学习笔记</option>
                            <option value="work">工作文档</option>
                            <option value="life">生活经验</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group mb-6">
                    <label for="knowledge-description">知识描述</label>
                    <textarea id="knowledge-description" name="description" 
                              placeholder="简要描述知识内容..." rows="3"></textarea>
                </div>
                
                <div class="form-group mb-6">
                    <label for="knowledge-content">知识内容</label>
                    <textarea id="knowledge-content" name="content" 
                              placeholder="详细的知识内容，支持Markdown格式..." rows="10"></textarea>
                    <p class="text-xs text-slate-500 mt-1">支持Markdown格式，可用于格式化内容</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="form-group">
                        <label for="knowledge-source">来源</label>
                        <input type="text" id="knowledge-source" name="source" 
                               placeholder="如：书籍、网站、课程等">
                    </div>
                    
                    <div class="form-group">
                        <label for="knowledge-link">参考链接</label>
                        <input type="url" id="knowledge-link" name="link" 
                               placeholder="https://example.com">
                    </div>
                </div>
                
                <div class="form-group mb-6">
                    <label for="knowledge-tags">标签</label>
                    <div class="flex gap-2">
                        <input type="text" id="knowledge-tags-input" class="tag-input"
                               placeholder="输入标签（按回车添加）">
                        <button type="button" id="add-tag-btn" class="px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-lg hover:bg-slate-700/50">
                            <i class="fa fa-plus"></i>
                        </button>
                    </div>
                    <div id="knowledge-tags-container" class="flex flex-wrap gap-2 mt-2">
                        <!-- 动态生成标签 -->
                    </div>
                    <div class="tag-suggestions">
                        <span class="tag-suggestion" data-tag="编程">编程</span>
                        <span class="tag-suggestion" data-tag="AI">AI</span>
                        <span class="tag-suggestion" data-tag="前端">前端</span>
                        <span class="tag-suggestion" data-tag="后端">后端</span>
                        <span class="tag-suggestion" data-tag="学习">学习</span>
                        <span class="tag-suggestion" data-tag="工具">工具</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="form-group">
                        <label class="flex items-center">
                            <input type="checkbox" id="knowledge-favorite" name="favorite" class="mr-3 w-5 h-5 rounded">
                            <span class="text-slate-300">添加到收藏</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="flex items-center">
                            <input type="checkbox" id="knowledge-public" name="public" class="mr-3 w-5 h-5 rounded">
                            <span class="text-slate-300">设为公开</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="flex items-center">
                            <input type="checkbox" id="knowledge-shareable" name="shareable" class="mr-3 w-5 h-5 rounded">
                            <span class="text-slate-300">允许分享</span>
                        </label>
                    </div>
                </div>
                
                <!-- 预览区域 -->
                <div class="preview-section mb-6">
                    <h4>内容预览</h4>
                    <div id="knowledge-preview" class="text-sm text-slate-400">
                        内容预览将在这里显示...
                    </div>
                </div>
                
                <input type="hidden" id="knowledge-id" name="id">
                <input type="hidden" id="knowledge-createdAt" name="createdAt">
                
                <div class="flex justify-end space-x-3 pt-4 border-t border-slate-700">
                    <button type="button" id="cancel-knowledge-btn" class="px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg hover:bg-slate-700/50 transition-colors">
                        取消
                    </button>
                    <button type="submit" id="save-knowledge-btn" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all">
                        保存知识
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 知识详情模态框 -->
    <div id="knowledge-detail-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/50" id="knowledge-detail-overlay"></div>
        <div class="glass-effect rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-blue-300" id="knowledge-detail-title">知识详情</h3>
                <button id="close-knowledge-detail-btn" class="p-2 rounded-lg hover:bg-slate-700 btn">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <div id="knowledge-detail-content">
                <!-- 通过JS动态生成 -->
            </div>
            
            <div class="flex justify-end space-x-3 pt-4 mt-6 border-t border-slate-700">
                <button id="edit-knowledge-detail-btn" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all">
                    <i class="fa fa-edit mr-2"></i>编辑
                </button>
                <button id="close-knowledge-detail-modal-btn" class="px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg hover:bg-slate-700/50 transition-colors">
                    关闭
                </button>
            </div>
        </div>
    </div>
    
    <!-- 头像选择模态框 -->
    <div id="avatar-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/50" id="avatar-modal-overlay"></div>
        <div class="glass-effect rounded-2xl p-6 w-full max-w-md max-h-[80vh] overflow-y-auto relative">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-blue-300">选择头像</h3>
                <button id="close-avatar-modal-btn" class="p-2 rounded-lg hover:bg-slate-700 btn">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <div class="mb-6">
                <h4 class="font-medium mb-3 text-slate-300">自定义颜色</h4>
                <div class="flex flex-wrap gap-3">
                    <div class="color-option bg-gradient-to-br from-blue-500 to-purple-500 selected" data-color="blue-purple"></div>
                    <div class="color-option bg-gradient-to-br from-green-500 to-teal-500" data-color="green-teal"></div>
                    <div class="color-option bg-gradient-to-br from-red-500 to-pink-500" data-color="red-pink"></div>
                    <div class="color-option bg-gradient-to-br from-yellow-500 to-orange-500" data-color="yellow-orange"></div>
                    <div class="color-option bg-gradient-to-br from-indigo-500 to-blue-500" data-color="indigo-blue"></div>
                    <div class="color-option bg-gradient-to-br from-purple-500 to-pink-500" data-color="purple-pink"></div>
                </div>
            </div>
            
            <div class="mb-6">
                <h4 class="font-medium mb-3 text-slate-300">上传头像</h4>
                <div class="border-2 border-dashed border-slate-700 rounded-lg p-6 text-center">
                    <i class="fa fa-cloud-upload text-3xl text-slate-400 mb-3"></i>
                    <p class="text-slate-400 mb-3">拖放图片或点击上传</p>
                    <input type="file" id="avatar-upload" accept="image/*" class="hidden">
                    <label for="avatar-upload" class="px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg hover:bg-slate-700/50 cursor-pointer inline-block">
                        选择文件
                    </label>
                    <p class="text-xs text-slate-500 mt-3">支持 JPG、PNG 格式，最大 2MB</p>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4 border-t border-slate-700">
                <button id="cancel-avatar-btn" class="px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg hover:bg-slate-700/50 transition-colors">
                    取消
                </button>
                <button id="save-avatar-btn" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all">
                    保存头像
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // 智谱API配置
        const GLM_CONFIG = {
            apiKey: '7140e63dc45448728c5a5bc5ee349d47.bQm0yFBzpeFU8Vwa',
            apiUrl: 'https://open.bigmodel.cn/api/paas/v4/chat/completions',
            model: 'glm-4',
            maxTokens: 2000,
            temperature: 0.7
        };
        
        // 预设提示词
        const PRESET_PROMPTS = {
            default: '你是一个友好且专业的AI助手，专注于回答基础问题。请以简洁明了、易于理解的方式回答用户的各类基础问题。如果遇到超出你知识范围的问题，诚实地告知用户，并提供相关的帮助建议。',
            teacher: '你是一位耐心且经验丰富的学习导师。请用通俗易懂的语言解释复杂概念，提供循序渐进的指导，鼓励用户提问，并在必要时提供学习资源和练习建议。注重培养学生的思考能力和学习兴趣。',
            creative: '你是一个富有创意和想象力的助手。请提供新颖的观点、独特的解决方案和创造性的建议。鼓励用户跳出思维定式，探索不同的可能性，并在必要时提供灵感启发和创意示例。',
            strict: '你是一个严谨、精确的专家助手。请提供准确、详实、有据可依的回答，避免模糊和不准确的表述。专注于事实和逻辑，在必要时提供数据和引用来源，确保信息的可靠性和权威性。'
        };
        
        // 应用状态管理
        const AppState = {
            currentConversation: [],
            conversations: [],
            tasks: [],
            knowledge: [],
            knowledgeCategories: ['technology', 'learning', 'work', 'life', 'other'],
            knowledgeTags: ['编程', 'AI', '前端', '后端', '学习', '工具', '设计', '算法', '数据库', '网络'],
            settings: {
                theme: 'dark',
                voiceEnabled: false,
                autoScroll: true,
                useAPI: true,
                systemPrompt: PRESET_PROMPTS.default,
                model: 'glm-4',
                temperature: 0.7,
                apiKey: '7140e63dc45448728c5a5bc5ee349d47.bQm0yFBzpeFU8Vwa',
                sidebarCollapsed: false
            },
            stats: {
                todayCount: 0,
                weekCount: 0,
                totalCount: 0,
                lastReset: null,
                knowledgeStats: {
                    total: 0,
                    today: 0,
                    categories: {},
                    tags: {}
                }
            },
            user: {
                isLoggedIn: false,
                username: '',
                email: '',
                phone: '',
                bio: '',
                description: '',
                avatarColor: 'blue-purple',
                avatarText: 'U',
                isGuest: false,
                loginTime: null,
                createdAt: new Date().toISOString(),
                lastLogin: null,
                activeDays: 1,
                sessions: [],
                conversationCount: 0,
                taskCount: 0,
                knowledgeCount: 0
            },
            messageFeedback: {},
            editHistory: [],
            taskFilters: {
                current: 'all',
                searchQuery: ''
            },
            knowledgeFilters: {
                current: 'all',
                searchQuery: '',
                category: null,
                tag: null
            },
            taskTags: ['工作', '学习', '重要', '紧急', '个人', '健康', '项目', '会议']
        };
        
        // 快捷指令数据库
        const QuickCommands = [
            {
                icon: 'fa-pencil',
                title: '写作助手',
                description: '帮助撰写文章、邮件、报告等',
                command: '帮我写一封感谢邮件',
                color: 'text-blue-300'
            },
            {
                icon: 'fa-code',
                title: '代码助手',
                description: '编程问题解答和代码优化',
                command: 'Python列表和元组有什么区别',
                color: 'text-green-300'
            },
            {
                icon: 'fa-graduation-cap',
                title: '学习导师',
                description: '解答学习疑问，提供学习建议',
                command: '如何学习人工智能',
                color: 'text-purple-300'
            },
            {
                icon: 'fa-life-ring',
                title: '生活助手',
                description: '日常问题解答和建议',
                command: '今天天气怎么样',
                color: 'text-yellow-300'
            },
            {
                icon: 'fa-heartbeat',
                title: '健康助手',
                description: '健身、饮食和健康建议',
                command: '帮我制定一个健身计划',
                color: 'text-red-300'
            },
            {
                icon: 'fa-language',
                title: '翻译助手',
                description: '多语言翻译服务',
                command: '帮我翻译这段英文',
                color: 'text-teal-300'
            },
            {
                icon: 'fa-lightbulb-o',
                title: '创意助手',
                description: '提供创意灵感和想法',
                command: '为我的新产品起名字',
                color: 'text-orange-300'
            },
            {
                icon: 'fa-bar-chart',
                title: '数据分析',
                description: '数据分析与可视化建议',
                command: '如何分析销售数据',
                color: 'text-pink-300'
            }
        ];
        
        // 示例任务数据
        const sampleTasks = [
            {
                id: 1,
                title: '完成项目报告',
                description: '整理上周的项目进展，编写详细的项目报告，包括数据分析部分',
                priority: 'high',
                category: 'work',
                progress: 75,
                dueDate: '2024-12-15',
                tags: ['工作', '重要', '项目'],
                important: true,
                completed: false,
                createdAt: '2024-12-10',
                completedAt: null
            },
            {
                id: 2,
                title: '学习React Hooks',
                description: '完成React Hooks的官方文档学习，并完成3个练习项目',
                priority: 'medium',
                category: 'study',
                progress: 50,
                dueDate: '2024-12-20',
                tags: ['学习', '前端'],
                important: false,
                completed: false,
                createdAt: '2024-12-08',
                completedAt: null
            },
            {
                id: 3,
                title: '健身计划',
                description: '每周三次健身，包括有氧运动和力量训练',
                priority: 'low',
                category: 'health',
                progress: 100,
                dueDate: '2024-12-12',
                tags: ['健康', '个人'],
                important: false,
                completed: true,
                createdAt: '2024-12-01',
                completedAt: '2024-12-12'
            },
            {
                id: 4,
                title: '团队会议准备',
                description: '准备下周团队会议的PPT和议程安排',
                priority: 'high',
                category: 'work',
                progress: 30,
                dueDate: '2024-12-14',
                tags: ['工作', '会议', '紧急'],
                important: true,
                completed: false,
                createdAt: '2024-12-11',
                completedAt: null
            }
        ];
        
        // 示例知识库数据
        const sampleKnowledge = [
            {
                id: 1,
                title: 'JavaScript闭包详解',
                description: '深入理解JavaScript闭包的概念、原理和应用场景',
                category: 'technology',
                content: `# JavaScript闭包详解

## 什么是闭包？
闭包是指有权访问另一个函数作用域中的变量的函数。

## 闭包的特性
1. **函数嵌套**：闭包通常发生在函数嵌套中
2. **内部函数引用外部变量**：内部函数引用了外部函数的变量
3. **外部函数执行完毕**：外部函数执行完毕后，其变量仍然被内部函数引用

## 应用场景
1. 封装私有变量
2. 创建模块化代码
3. 实现函数柯里化
4. 缓存计算结果

## 示例代码
\`\`\`javascript
function createCounter() {
    let count = 0;
    return function() {
        count++;
        return count;
    };
}

const counter = createCounter();
console.log(counter()); // 1
console.log(counter()); // 2
\`\`\``,
                tags: ['JavaScript', '编程', '前端', '闭包'],
                source: '《JavaScript高级程序设计》',
                link: 'https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Closures',
                favorite: true,
                public: true,
                shareable: true,
                createdAt: '2024-12-10',
                updatedAt: '2024-12-10'
            },
            {
                id: 2,
                title: '机器学习基础概念',
                description: '机器学习的基本概念、算法分类和应用领域',
                category: 'technology',
                content: `# 机器学习基础概念

## 什么是机器学习？
机器学习是人工智能的一个分支，它使计算机能够从数据中学习并做出预测或决策，而无需显式编程。

## 主要算法分类
1. **监督学习**：使用标记数据进行训练
   - 分类（Classification）
   - 回归（Regression）
2. **无监督学习**：使用未标记数据进行训练
   - 聚类（Clustering）
   - 降维（Dimensionality Reduction）
3. **强化学习**：通过试错学习最优策略

## 应用领域
- 图像识别
- 自然语言处理
- 推荐系统
- 自动驾驶

## 常用库
- TensorFlow
- PyTorch
- Scikit-learn`,
                tags: ['AI', '机器学习', '算法', 'Python'],
                source: '《机器学习》周志华',
                link: '',
                favorite: true,
                public: true,
                shareable: true,
                createdAt: '2024-12-09',
                updatedAt: '2024-12-09'
            },
            {
                id: 3,
                title: '高效学习方法',
                description: '科学的学习方法和技巧，提高学习效率',
                category: 'learning',
                content: `# 高效学习方法

## 1. 费曼学习法
**核心思想**：用简单的话向别人解释复杂概念
**步骤**：
1. 选择一个概念
2. 向别人讲解这个概念
3. 发现自己的知识盲点
4. 重新学习并简化表达

## 2. 番茄工作法
**核心思想**：25分钟专注工作 + 5分钟休息
**优点**：
- 提高专注力
- 减少拖延
- 合理安排休息

## 3. 主动回忆法
**核心思想**：主动提取记忆，而不是被动阅读
**方法**：
- 学习后立即回忆
- 制作闪卡
- 自我测试

## 4. 间隔重复
**核心思想**：在合适的时间间隔复习
**应用**：
- 使用Anki等闪卡软件
- 制定复习计划表`,
                tags: ['学习', '方法', '效率', '记忆'],
                source: '《如何高效学习》',
                link: '',
                favorite: false,
                public: true,
                shareable: true,
                createdAt: '2024-12-08',
                updatedAt: '2024-12-08'
            },
            {
                id: 4,
                title: '项目管理最佳实践',
                description: '项目管理的核心原则和实用工具',
                category: 'work',
                content: `# 项目管理最佳实践

## 核心原则
1. **明确目标**：SMART原则
   - Specific（具体的）
   - Measurable（可衡量的）
   - Achievable（可实现的）
   - Relevant（相关的）
   - Time-bound（有时限的）

2. **有效沟通**：
   - 定期会议
   - 使用协作工具
   - 明确责任分工

3. **风险管理**：
   - 识别潜在风险
   - 制定应对策略
   - 监控风险变化

## 常用工具
1. **项目管理**：Jira, Trello, Asana
2. **文档协作**：Notion, Confluence, Google Docs
3. **代码管理**：Git, GitHub, GitLab
4. **沟通工具**：Slack, Microsoft Teams, Zoom

## 敏捷开发
- Scrum框架
- 每日站会
- 冲刺计划
- 回顾会议`,
                tags: ['工作', '项目管理', '工具', '协作'],
                source: '《敏捷软件开发》',
                link: '',
                favorite: false,
                public: true,
                shareable: true,
                createdAt: '2024-12-07',
                updatedAt: '2024-12-07'
            }
        ];
        
        // 页面状态管理
        let currentPage = 'chat';
        let isSidebarAnimating = false;
        let currentConversationId = null;
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            // 页面加载完成后添加loaded类，防止初始渲染抖动
            setTimeout(() => {
                document.body.classList.add('loaded');
            }, 50);
            
            initLoginComponents();
            checkLoginStatus();
            createParticles();
        });
        
        // 初始化登录组件
        function initLoginComponents() {
            const loginForm = document.getElementById('login-form');
            const wechatLogin = document.getElementById('wechat-login');
            const qqLogin = document.getElementById('qq-login');
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const registerLink = document.getElementById('register-link');
            
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });
            
            wechatLogin.addEventListener('click', function() {
                showNotification('微信登录功能开发中', 'info');
            });
            
            qqLogin.addEventListener('click', function() {
                showNotification('QQ登录功能开发中', 'info');
            });
            
            forgotPasswordLink.addEventListener('click', function(e) {
                e.preventDefault();
                showNotification('密码重置功能开发中', 'info');
            });
            
            registerLink.addEventListener('click', function(e) {
                e.preventDefault();
                showNotification('注册功能开发中', 'info');
            });
            
            const rememberMe = document.getElementById('remember-me');
            const savedUser = localStorage.getItem('aiAssistantRememberedUser');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    if (userData.username) {
                        document.getElementById('login-username').value = userData.username;
                        rememberMe.checked = true;
                    }
                } catch (e) {
                    console.error('加载保存的用户信息失败:', e);
                }
            }
        }
        
        // 处理登录
        function handleLogin() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            const loginBtn = document.getElementById('login-btn-text');
            const loginLoader = document.getElementById('login-loader');
            
            if (username.length < 3) {
                document.getElementById('username-error').style.display = 'block';
                return;
            }
            
            if (password.length < 6) {
                document.getElementById('password-error').style.display = 'block';
                return;
            }
            
            loginBtn.textContent = '登录中...';
            loginLoader.classList.remove('hidden');
            
            setTimeout(() => {
                if (rememberMe) {
                    localStorage.setItem('aiAssistantRememberedUser', JSON.stringify({
                        username: username,
                        timestamp: Date.now()
                    }));
                } else {
                    localStorage.removeItem('aiAssistantRememberedUser');
                }
                
                AppState.user = {
                    isLoggedIn: true,
                    username: username,
                    email: `${username}@example.com`,
                    phone: '',
                    bio: '慧助手用户',
                    description: '这是一个慧助手的用户',
                    avatarColor: 'blue-purple',
                    avatarText: username.charAt(0).toUpperCase(),
                    isGuest: false,
                    loginTime: new Date(),
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    activeDays: 1,
                    sessions: [],
                    conversationCount: 0,
                    taskCount: 0,
                    knowledgeCount: 0
                };
                
                // 创建当前会话
                const sessionId = 'session-' + Date.now();
                AppState.user.sessions.push({
                    id: sessionId,
                    device: getDeviceInfo(),
                    location: '未知位置',
                    ip: '127.0.0.1',
                    lastActivity: new Date().toISOString(),
                    isCurrent: true
                });
                
                saveLoginState();
                showMainApp();
                
            }, 1500);
        }
        
        // 获取设备信息
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            let device = '桌面设备';
            
            if (/Mobile|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua)) {
                device = '移动设备';
            } else if (/Tablet|iPad/i.test(ua)) {
                device = '平板设备';
            }
            
            return device + ' - ' + (navigator.platform || '未知平台');
        }
        
        // 显示主应用
        function showMainApp() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-app').classList.remove('hidden');
            
            updateUserInfo();
            initComponents();
            loadState();
            renderQuickCommands();
            updateStats();
            updateAccountStats();
            
            document.documentElement.classList.add('dark');
            showNotification(`欢迎回来，${AppState.user.username}！`, 'success');
            showNotification('智谱API已配置，可以开始使用AI对话功能', 'info');
            
            // 确保页面稳定后再显示
            setTimeout(() => {
                requestAnimationFrame(() => {
                    document.body.classList.add('loaded');
                });
            }, 100);
        }
        
        // 更新用户信息显示
        function updateUserInfo() {
            const user = AppState.user;
            const avatarChar = user.avatarText || user.username.charAt(0).toUpperCase();
            
            // 更新顶部导航用户信息
            document.getElementById('user-avatar').textContent = avatarChar;
            document.getElementById('username-display').textContent = user.username;
            document.getElementById('user-info').classList.remove('hidden');
            
            // 更新移动端用户信息
            document.getElementById('mobile-user-avatar').textContent = avatarChar;
            document.getElementById('mobile-username-display').textContent = user.username;
            
            // 更新账户页面信息
            updateAccountPage();
        }
        
        // 更新账户页面信息
        function updateAccountPage() {
            const user = AppState.user;
            
            // 更新账户页面显示
            document.getElementById('account-avatar-text').textContent = user.avatarText;
            document.getElementById('account-username').value = user.username || '';
            document.getElementById('account-email').value = user.email || '';
            document.getElementById('account-phone').value = user.phone || '';
            document.getElementById('account-bio').value = user.bio || '';
            document.getElementById('account-description').value = user.description || '';
            
            // 格式化日期
            const createdDate = new Date(user.createdAt);
            document.getElementById('account-created-date').textContent = 
                createdDate.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            
            // 更新账户统计
            document.getElementById('account-conversation-count').textContent = user.conversationCount || 0;
            document.getElementById('account-task-count').textContent = user.taskCount || 0;
            document.getElementById('account-knowledge-count').textContent = user.knowledgeCount || 0;
            document.getElementById('account-active-days').textContent = user.activeDays || 1;
            
            // 更新头像颜色
            updateAvatarColor(user.avatarColor);
        }
        
        // 更新头像颜色
        function updateAvatarColor(color) {
            const avatarElements = document.querySelectorAll('.account-avatar > div');
            const colorMap = {
                'blue-purple': 'from-blue-500 to-purple-500',
                'green-teal': 'from-green-500 to-teal-500',
                'red-pink': 'from-red-500 to-pink-500',
                'yellow-orange': 'from-yellow-500 to-orange-500',
                'indigo-blue': 'from-indigo-500 to-blue-500',
                'purple-pink': 'from-purple-500 to-pink-500'
            };
            
            avatarElements.forEach(avatar => {
                avatar.className = avatar.className.replace(/from-[\w-]+ to-[\w-]+/g, colorMap[color] || 'from-blue-500 to-purple-500');
            });
        }
        
        // 检查登录状态
        function checkLoginStatus() {
            const savedState = localStorage.getItem('aiAssistantLoginState');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    if (state.user && state.user.isLoggedIn) {
                        const loginTime = new Date(state.user.loginTime);
                        const now = new Date();
                        const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
                        
                        if (hoursDiff < 24) {
                            AppState.user = state.user;
                            
                            // 更新上次登录时间
                            AppState.user.lastLogin = new Date().toISOString();
                            
                            // 更新活跃天数（如果上次登录不是今天）
                            const lastLoginDate = new Date(state.user.lastLogin || state.user.loginTime);
                            const today = new Date();
                            if (lastLoginDate.toDateString() !== today.toDateString()) {
                                AppState.user.activeDays = (state.user.activeDays || 1) + 1;
                            }
                            
                            // 更新会话信息
                            if (!state.user.sessions) {
                                state.user.sessions = [];
                            }
                            
                            // 添加当前会话
                            const sessionId = 'session-' + Date.now();
                            state.user.sessions = state.user.sessions.filter(s => !s.isCurrent);
                            state.user.sessions.push({
                                id: sessionId,
                                device: getDeviceInfo(),
                                location: '未知位置',
                                ip: '127.0.0.1',
                                lastActivity: new Date().toISOString(),
                                isCurrent: true
                            });
                            
                            showMainApp();
                            return;
                        } else {
                            localStorage.removeItem('aiAssistantLoginState');
                        }
                    }
                } catch (e) {
                    console.error('检查登录状态失败:', e);
                }
            }
            
            document.getElementById('login-page').style.display = 'flex';
        }
        
        // 保存登录状态
        function saveLoginState() {
            const loginState = {
                user: AppState.user,
                timestamp: Date.now()
            };
            localStorage.setItem('aiAssistantLoginState', JSON.stringify(loginState));
        }
        
        // 退出登录（增强版）
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                // 记录退出时间
                AppState.user.lastLogout = new Date().toISOString();
                
                // 清除当前会话标记
                AppState.user.sessions = AppState.user.sessions.map(session => ({
                    ...session,
                    isCurrent: false
                }));
                
                // 保存用户状态
                saveLoginState();
                
                // 清除登录状态
                localStorage.removeItem('aiAssistantLoginState');
                
                AppState.user = {
                    isLoggedIn: false,
                    username: '',
                    email: '',
                    phone: '',
                    bio: '',
                    description: '',
                    avatarColor: 'blue-purple',
                    avatarText: 'U',
                    isGuest: false,
                    loginTime: null,
                    createdAt: new Date().toISOString(),
                    lastLogin: null,
                    activeDays: 1,
                    sessions: [],
                    conversationCount: 0,
                    taskCount: 0,
                    knowledgeCount: 0
                };
                
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('login-page').style.display = 'flex';
                
                document.getElementById('login-username').value = '';
                document.getElementById('login-password').value = '';
                document.getElementById('login-btn-text').textContent = '登录';
                document.getElementById('login-loader').classList.add('hidden');
                
                showNotification('已成功退出登录', 'success');
            }
        }
        
        // 初始化主应用组件
        function initComponents() {
            // 页面切换
            const chatLink = document.getElementById('chat-link');
            const tasksLink = document.getElementById('tasks-link');
            const knowledgeLink = document.getElementById('knowledge-link');
            const accountLink = document.getElementById('account-link');
            const settingsLink = document.getElementById('settings-link');
            
            const mobileChatLink = document.getElementById('mobile-chat-link');
            const mobileTasksLink = document.getElementById('mobile-tasks-link');
            const mobileKnowledgeLink = document.getElementById('mobile-knowledge-link');
            const mobileAccountLink = document.getElementById('mobile-account-link');
            const mobileSettingsLink = document.getElementById('mobile-settings-link');
            const mobileLogoutLink = document.getElementById('mobile-logout-link');
            
            // 页面元素
            const chatPage = document.getElementById('chat-page');
            const tasksPage = document.getElementById('tasks-page');
            const knowledgePage = document.getElementById('knowledge-page');
            const accountPage = document.getElementById('account-page');
            const settingsPage = document.getElementById('settings-page');
            
            // 返回按钮
            const backToChatBtn = document.getElementById('back-to-chat-btn');
            const backToChatFromTasks = document.getElementById('back-to-chat-from-tasks');
            const backToChatFromKnowledge = document.getElementById('back-to-chat-from-knowledge');
            const backToChatFromAccount = document.getElementById('back-to-chat-from-account');
            
            // 设置页面功能
            const settingsApiKey = document.getElementById('settings-api-key');
            const settingsModelSelect = document.getElementById('settings-model-select');
            const settingsSystemPrompt = document.getElementById('settings-system-prompt');
            const settingsAutoScroll = document.getElementById('settings-auto-scroll');
            const settingsVoiceEnabled = document.getElementById('settings-voice-enabled');
            const saveApiBtn = document.getElementById('save-api-btn');
            const resetSettingsBtn = document.getElementById('reset-settings-btn');
            
            // 退出登录按钮
            const logoutBtn = document.getElementById('logout-btn');
            logoutBtn.addEventListener('click', logout);
            if (mobileLogoutLink) {
                mobileLogoutLink.addEventListener('click', logout);
            }
            
            // 切换页面函数
            function switchPage(page) {
                chatPage.classList.add('hidden');
                tasksPage.classList.add('hidden');
                knowledgePage.classList.add('hidden');
                accountPage.classList.add('hidden');
                settingsPage.classList.add('hidden');
                
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                
                switch(page) {
                    case 'chat':
                        chatPage.classList.remove('hidden');
                        chatLink.classList.add('active');
                        currentPage = 'chat';
                        break;
                    case 'tasks':
                        tasksPage.classList.remove('hidden');
                        tasksLink.classList.add('active');
                        currentPage = 'tasks';
                        loadTasks();
                        break;
                    case 'knowledge':
                        knowledgePage.classList.remove('hidden');
                        knowledgeLink.classList.add('active');
                        currentPage = 'knowledge';
                        loadKnowledge();
                        break;
                    case 'account':
                        accountPage.classList.remove('hidden');
                        accountLink.classList.add('active');
                        currentPage = 'account';
                        loadAccountPage();
                        break;
                    case 'settings':
                        settingsPage.classList.remove('hidden');
                        settingsLink.classList.add('active');
                        currentPage = 'settings';
                        loadSettingsToPage();
                        break;
                }
                
                closeMobileMenuFunc();
            }
            
            // 页面切换事件监听
            chatLink.addEventListener('click', () => switchPage('chat'));
            tasksLink.addEventListener('click', () => switchPage('tasks'));
            knowledgeLink.addEventListener('click', () => switchPage('knowledge'));
            accountLink.addEventListener('click', () => switchPage('account'));
            settingsLink.addEventListener('click', () => switchPage('settings'));
            
            mobileChatLink.addEventListener('click', () => switchPage('chat'));
            mobileTasksLink.addEventListener('click', () => switchPage('tasks'));
            mobileKnowledgeLink.addEventListener('click', () => switchPage('knowledge'));
            mobileAccountLink.addEventListener('click', () => switchPage('account'));
            mobileSettingsLink.addEventListener('click', () => switchPage('settings'));
            
            backToChatBtn.addEventListener('click', () => switchPage('chat'));
            backToChatFromTasks.addEventListener('click', () => switchPage('chat'));
            backToChatFromKnowledge.addEventListener('click', () => switchPage('chat'));
            backToChatFromAccount.addEventListener('click', () => switchPage('chat'));
            
            // 设置页面保存API设置
            saveApiBtn.addEventListener('click', function() {
                const apiKey = settingsApiKey.value.trim();
                const model = settingsModelSelect.value;
                
                if (!apiKey) {
                    showNotification('请输入API Key', 'warning');
                    return;
                }
                
                GLM_CONFIG.apiKey = apiKey;
                GLM_CONFIG.model = model;
                
                AppState.settings.apiKey = apiKey;
                AppState.settings.model = model;
                AppState.settings.systemPrompt = settingsSystemPrompt.value.trim() || AppState.settings.systemPrompt;
                AppState.settings.autoScroll = settingsAutoScroll.checked;
                AppState.settings.voiceEnabled = settingsVoiceEnabled.checked;
                
                saveState();
                showNotification('设置已保存', 'success');
                
                if (apiKey) {
                    AppState.settings.useAPI = true;
                    const apiToggleBtn = document.getElementById('api-toggle');
                    if (apiToggleBtn) {
                        apiToggleBtn.setAttribute('data-tooltip', '使用API');
                        apiToggleBtn.innerHTML = '<i class="fa fa-cloud text-green-400"></i>';
                    }
                }
            });
            
            // 重置设置
            resetSettingsBtn.addEventListener('click', function() {
                if (confirm('确定要重置所有设置吗？这将清除所有保存的配置。')) {
                    localStorage.removeItem('aiAssistantState');
                    
                    AppState.settings = {
                        theme: 'dark',
                        voiceEnabled: false,
                        autoScroll: true,
                        useAPI: true,
                        systemPrompt: PRESET_PROMPTS.default,
                        model: 'glm-4',
                        temperature: 0.7,
                        apiKey: '7140e63dc45448728c5a5bc5ee349d47.bQm0yFBzpeFU8Vwa',
                        sidebarCollapsed: false
                    };
                    
                    GLM_CONFIG.apiKey = '7140e63dc45448728c5a5bc5ee349d47.bQm0yFBzpeFU8Vwa';
                    GLM_CONFIG.model = 'glm-4';
                    GLM_CONFIG.temperature = 0.7;
                    
                    loadSettingsToPage();
                    initSidebarToggle();
                    showNotification('设置已重置（保留您的API Key）', 'success');
                }
            });
            
            // 加载设置到设置页面
            function loadSettingsToPage() {
                settingsApiKey.value = GLM_CONFIG.apiKey;
                settingsModelSelect.value = AppState.settings.model;
                settingsSystemPrompt.value = AppState.settings.systemPrompt;
                settingsAutoScroll.checked = AppState.settings.autoScroll;
                settingsVoiceEnabled.checked = AppState.settings.voiceEnabled;
            }
            
            // 聊天功能初始化
            initChatComponents();
            initSidebarToggle();
            // 任务功能初始化
            initTaskComponents();
            // 知识库功能初始化
            initKnowledgeComponents();
            // 账户功能初始化
            initAccountComponents();
        }
        
        // 初始化账户组件
        function initAccountComponents() {
            // 头像编辑
            const avatarEditBtn = document.getElementById('avatar-edit-btn');
            const avatarModal = document.getElementById('avatar-modal');
            const closeAvatarModalBtn = document.getElementById('close-avatar-modal-btn');
            const cancelAvatarBtn = document.getElementById('cancel-avatar-btn');
            const saveAvatarBtn = document.getElementById('save-avatar-btn');
            const avatarModalOverlay = document.getElementById('avatar-modal-overlay');
            const avatarUpload = document.getElementById('avatar-upload');
            const colorOptions = document.querySelectorAll('.color-option');
            
            // 个人信息保存
            const saveProfileBtn = document.getElementById('save-profile-btn');
            
            // 密码修改
            const changePasswordBtn = document.getElementById('change-password-btn');
            const newPasswordInput = document.getElementById('new-password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            
            // 会话管理
            const refreshSessionsBtn = document.getElementById('refresh-sessions-btn');
            
            // 危险操作
            const exportDataBtn = document.getElementById('export-data-btn');
            const clearDataBtn = document.getElementById('clear-data-btn');
            const deleteAccountBtn = document.getElementById('delete-account-btn');
            
            // 打开头像编辑模态框
            avatarEditBtn.addEventListener('click', function() {
                openAvatarModal();
            });
            
            // 关闭头像模态框
            closeAvatarModalBtn.addEventListener('click', closeAvatarModal);
            cancelAvatarBtn.addEventListener('click', closeAvatarModal);
            avatarModalOverlay.addEventListener('click', closeAvatarModal);
            
            function openAvatarModal() {
                // 设置当前选择的颜色
                colorOptions.forEach(option => {
                    const color = option.getAttribute('data-color');
                    option.classList.toggle('selected', color === AppState.user.avatarColor);
                });
                
                avatarModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
            
            function closeAvatarModal() {
                avatarModal.classList.add('hidden');
                document.body.style.overflow = '';
            }
            
            // 颜色选择
            colorOptions.forEach(option => {
                option.addEventListener('click', function() {
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
            
            // 头像上传
            avatarUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    showNotification('请选择图片文件', 'error');
                    return;
                }
                
                if (file.size > 2 * 1024 * 1024) {
                    showNotification('图片大小不能超过2MB', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    // 这里可以处理上传的图片
                    // 由于是演示，我们只显示成功消息
                    showNotification('头像上传成功（演示功能）', 'success');
                };
                reader.readAsDataURL(file);
            });
            
            // 保存头像
            saveAvatarBtn.addEventListener('click', function() {
                // 获取选择的颜色
                const selectedColor = document.querySelector('.color-option.selected').getAttribute('data-color');
                AppState.user.avatarColor = selectedColor;
                
                // 更新头像显示
                updateAvatarColor(selectedColor);
                updateUserInfo();
                
                saveState();
                closeAvatarModal();
                showNotification('头像已更新', 'success');
            });
            
            // 保存个人信息
            saveProfileBtn.addEventListener('click', function() {
                const username = document.getElementById('account-username').value.trim();
                const email = document.getElementById('account-email').value.trim();
                const phone = document.getElementById('account-phone').value.trim();
                const bio = document.getElementById('account-bio').value.trim();
                const description = document.getElementById('account-description').value.trim();
                
                if (!username) {
                    showNotification('用户名不能为空', 'error');
                    return;
                }
                
                // 更新用户信息
                AppState.user.username = username;
                AppState.user.email = email;
                AppState.user.phone = phone;
                AppState.user.bio = bio;
                AppState.user.description = description;
                AppState.user.avatarText = username.charAt(0).toUpperCase();
                
                // 更新显示
                updateUserInfo();
                saveState();
                showNotification('个人信息已保存', 'success');
            });
            
            // 密码强度检测
            newPasswordInput.addEventListener('input', function() {
                updatePasswordStrength(this.value);
            });
            
            function updatePasswordStrength(password) {
                let strength = 0;
                const bar = document.getElementById('password-strength-bar');
                const text = document.getElementById('password-strength-text');
                
                if (password.length >= 8) strength++;
                if (/[A-Z]/.test(password)) strength++;
                if (/[a-z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^A-Za-z0-9]/.test(password)) strength++;
                
                let width, color, label;
                switch(strength) {
                    case 0:
                    case 1:
                        width = '20%';
                        color = '#ef4444'; // red-500
                        label = '非常弱';
                        break;
                    case 2:
                        width = '40%';
                        color = '#f97316'; // orange-500
                        label = '弱';
                        break;
                    case 3:
                        width = '60%';
                        color = '#eab308'; // yellow-500
                        label = '中等';
                        break;
                    case 4:
                        width = '80%';
                        color = '#22c55e'; // green-500
                        label = '强';
                        break;
                    case 5:
                        width = '100%';
                        color = '#10b981'; // emerald-500
                        label = '非常强';
                        break;
                }
                
                bar.style.width = width;
                bar.style.backgroundColor = color;
                text.textContent = `密码强度：${label}`;
                text.style.color = color;
            }
            
            // 修改密码
            changePasswordBtn.addEventListener('click', function() {
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                if (!currentPassword) {
                    showNotification('请输入当前密码', 'error');
                    return;
                }
                
                if (newPassword.length < 6) {
                    showNotification('新密码至少需要6位字符', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showNotification('两次输入的密码不一致', 'error');
                    return;
                }
                
                // 演示功能 - 实际应用中这里需要验证当前密码
                showNotification('密码修改成功（演示功能）', 'success');
                
                // 清空密码输入框
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
                
                // 重置密码强度显示
                updatePasswordStrength('');
            });
            
            // 刷新会话列表
            refreshSessionsBtn.addEventListener('click', function() {
                loadSessions();
                showNotification('会话列表已刷新', 'success');
            });
            
            // 导出所有数据
            exportDataBtn.addEventListener('click', function() {
                exportAllData();
            });
            
            // 清空所有数据
            clearDataBtn.addEventListener('click', function() {
                if (confirm('确定要清空所有数据吗？此操作不可恢复！')) {
                    clearAllData();
                }
            });
            
            // 删除账户
            deleteAccountBtn.addEventListener('click', function() {
                if (confirm('确定要删除账户吗？此操作将永久删除您的所有数据，不可恢复！')) {
                    deleteAccount();
                }
            });
        }
        
        // 加载账户页面
        function loadAccountPage() {
            updateAccountPage();
            loadSessions();
        }
        
        // 加载会话列表
        function loadSessions() {
            const sessionsList = document.getElementById('sessions-list');
            
            if (!AppState.user.sessions || AppState.user.sessions.length === 0) {
                sessionsList.innerHTML = '<p class="text-slate-400 text-center py-4">暂无登录会话</p>';
                return;
            }
            
            sessionsList.innerHTML = '';
            
            AppState.user.sessions.forEach(session => {
                const sessionElement = document.createElement('div');
                sessionElement.className = `session-item ${session.isCurrent ? 'current' : ''}`;
                
                const lastActivity = new Date(session.lastActivity);
                const timeAgo = getTimeAgo(lastActivity);
                
                sessionElement.innerHTML = `
                    <div class="session-info">
                        <h4>${session.device}</h4>
                        <div class="session-details">
                            <div>位置：${session.location}</div>
                            <div>IP：${session.ip}</div>
                            <div>最后活动：${timeAgo}</div>
                        </div>
                    </div>
                    <div class="session-actions">
                        ${session.isCurrent ? 
                            '<span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded">当前会话</span>' : 
                            '<button class="px-3 py-1 bg-slate-800/50 border border-slate-700 rounded text-xs hover:bg-slate-700/50 transition-colors" data-session-id="${session.id}">结束会话</button>'
                        }
                    </div>
                `;
                
                sessionsList.appendChild(sessionElement);
            });
            
            // 添加结束会话按钮事件
            sessionsList.querySelectorAll('button[data-session-id]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sessionId = this.getAttribute('data-session-id');
                    endSession(sessionId);
                });
            });
        }
        
        // 获取时间间隔描述
        function getTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return '刚刚';
            if (diff < 3600) return Math.floor(diff / 60) + '分钟前';
            if (diff < 86400) return Math.floor(diff / 3600) + '小时前';
            if (diff < 2592000) return Math.floor(diff / 86400) + '天前';
            if (diff < 31536000) return Math.floor(diff / 2592000) + '个月前';
            return Math.floor(diff / 31536000) + '年前';
        }
        
        // 结束会话
        function endSession(sessionId) {
            AppState.user.sessions = AppState.user.sessions.filter(session => session.id !== sessionId);
            saveState();
            loadSessions();
            showNotification('会话已结束', 'success');
        }
        
        // 导出所有数据
        function exportAllData() {
            const exportData = {
                user: AppState.user,
                conversations: AppState.conversations,
                tasks: AppState.tasks,
                knowledge: AppState.knowledge,
                settings: AppState.settings,
                stats: AppState.stats,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
                type: 'application/json' 
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-assistant-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('所有数据已导出', 'success');
        }
        
        // 清空所有数据
        function clearAllData() {
            // 重置应用状态
            AppState.currentConversation = [];
            AppState.conversations = [];
            AppState.tasks = [...sampleTasks];
            AppState.knowledge = [...sampleKnowledge];
            AppState.messageFeedback = {};
            AppState.editHistory = [];
            
            // 重置统计
            AppState.stats = {
                todayCount: 0,
                weekCount: 0,
                totalCount: 0,
                lastReset: null,
                knowledgeStats: {
                    total: 0,
                    today: 0,
                    categories: {},
                    tags: {}
                }
            };
            
            // 保存状态
            saveState();
            
            // 重新加载数据
            if (currentPage === 'tasks') loadTasks();
            if (currentPage === 'knowledge') loadKnowledge();
            if (currentPage === 'chat') {
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = `
                    <div class="chat-bubble">
                        <div class="ai-bubble">
                            <p class="text-sm">🎉 数据已清空！新的对话已开始！</p>
                        </div>
                        <div class="message-time mt-2 flex items-center">
                            <i class="fa fa-clock-o text-xs mr-1"></i>
                            <span>刚刚</span>
                        </div>
                    </div>
                `;
            }
            
            showNotification('所有数据已清空', 'success');
        }
        
        // 删除账户
        function deleteAccount() {
            // 确认删除
            const confirmText = prompt('请输入"DELETE"确认删除账户：');
            if (confirmText !== 'DELETE') {
                showNotification('删除操作已取消', 'info');
                return;
            }
            
            // 删除所有本地数据
            localStorage.removeItem('aiAssistantState');
            localStorage.removeItem('aiAssistantLoginState');
            localStorage.removeItem('aiAssistantRememberedUser');
            
            // 重置应用状态
            AppState.user = {
                isLoggedIn: false,
                username: '',
                email: '',
                phone: '',
                bio: '',
                description: '',
                avatarColor: 'blue-purple',
                avatarText: 'U',
                isGuest: false,
                loginTime: null,
                createdAt: new Date().toISOString(),
                lastLogin: null,
                activeDays: 1,
                sessions: [],
                conversationCount: 0,
                taskCount: 0,
                knowledgeCount: 0
            };
            
            // 返回登录页面
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-page').style.display = 'flex';
            
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            
            showNotification('账户已成功删除', 'success');
        }
        
        // 更新账户统计
        function updateAccountStats() {
            // 更新用户统计
            AppState.user.conversationCount = AppState.conversations.length;
            AppState.user.taskCount = AppState.tasks.length;
            AppState.user.knowledgeCount = AppState.knowledge.length;
            
            // 更新活跃天数（如果上次登录不是今天）
            const lastLoginDate = new Date(AppState.user.lastLogin || AppState.user.loginTime);
            const today = new Date();
            if (lastLoginDate.toDateString() !== today.toDateString()) {
                AppState.user.activeDays = (AppState.user.activeDays || 1) + 1;
                AppState.user.lastLogin = today.toISOString();
            }
            
            saveState();
        }
        
        // 初始化知识库组件
        function initKnowledgeComponents() {
            // 知识库按钮
            const createKnowledgeBtn = document.getElementById('create-knowledge-btn');
            const createFirstKnowledgeBtn = document.getElementById('create-first-knowledge-btn');
            const knowledgeModal = document.getElementById('knowledge-modal');
            const knowledgeModalOverlay = document.getElementById('knowledge-modal-overlay');
            const closeKnowledgeModalBtn = document.getElementById('close-knowledge-modal-btn');
            const cancelKnowledgeBtn = document.getElementById('cancel-knowledge-btn');
            const knowledgeForm = document.getElementById('knowledge-form');
            const knowledgeTagsInput = document.getElementById('knowledge-tags-input');
            const knowledgeTagsContainer = document.getElementById('knowledge-tags-container');
            const addTagBtn = document.getElementById('add-tag-btn');
            const knowledgeContent = document.getElementById('knowledge-content');
            const knowledgePreview = document.getElementById('knowledge-preview');
            
            // 知识详情模态框
            const knowledgeDetailModal = document.getElementById('knowledge-detail-modal');
            const knowledgeDetailOverlay = document.getElementById('knowledge-detail-overlay');
            const closeKnowledgeDetailBtn = document.getElementById('close-knowledge-detail-btn');
            const closeKnowledgeDetailModalBtn = document.getElementById('close-knowledge-detail-modal-btn');
            const editKnowledgeDetailBtn = document.getElementById('edit-knowledge-detail-btn');
            
            // 知识库筛选按钮
            const knowledgeFilterBtns = document.querySelectorAll('.knowledge-filter-btn');
            const knowledgeSearchInput = document.getElementById('knowledge-search-input');
            
            // 知识分类卡片
            const knowledgeCategoryCards = document.querySelectorAll('.knowledge-category-card');
            
            // 打开知识库模态框
            function openKnowledgeModal(knowledge = null) {
                const titleElement = document.getElementById('knowledge-modal-title');
                const form = document.getElementById('knowledge-form');
                const tagsContainer = document.getElementById('knowledge-tags-container');
                
                if (knowledge) {
                    // 编辑模式
                    titleElement.textContent = '编辑知识';
                    document.getElementById('knowledge-id').value = knowledge.id;
                    document.getElementById('knowledge-title').value = knowledge.title;
                    document.getElementById('knowledge-description').value = knowledge.description || '';
                    document.getElementById('knowledge-category').value = knowledge.category;
                    document.getElementById('knowledge-content').value = knowledge.content || '';
                    document.getElementById('knowledge-source').value = knowledge.source || '';
                    document.getElementById('knowledge-link').value = knowledge.link || '';
                    document.getElementById('knowledge-favorite').checked = knowledge.favorite || false;
                    document.getElementById('knowledge-public').checked = knowledge.public || false;
                    document.getElementById('knowledge-shareable').checked = knowledge.shareable || false;
                    document.getElementById('knowledge-createdAt').value = knowledge.createdAt || new Date().toISOString().split('T')[0];
                    
                    // 设置标签
                    tagsContainer.innerHTML = '';
                    if (knowledge.tags && knowledge.tags.length > 0) {
                        knowledge.tags.forEach(tag => {
                            addTagToKnowledgeContainer(tag);
                        });
                    }
                } else {
                    // 创建模式
                    titleElement.textContent = '新建知识';
                    form.reset();
                    document.getElementById('knowledge-id').value = '';
                    document.getElementById('knowledge-createdAt').value = new Date().toISOString().split('T')[0];
                    tagsContainer.innerHTML = '';
                    knowledgePreview.textContent = '内容预览将在这里显示...';
                }
                
                // 更新预览
                updateKnowledgePreview();
                
                knowledgeModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                document.getElementById('knowledge-title').focus();
            }
            
            // 关闭知识库模态框
            function closeKnowledgeModal() {
                knowledgeModal.classList.add('hidden');
                document.body.style.overflow = '';
            }
            
            // 打开知识详情模态框
            function openKnowledgeDetailModal(knowledge) {
                const titleElement = document.getElementById('knowledge-detail-title');
                const contentElement = document.getElementById('knowledge-detail-content');
                
                titleElement.textContent = knowledge.title;
                
                const categoryName = getKnowledgeCategoryName(knowledge.category);
                const categoryColor = getKnowledgeCategoryColor(knowledge.category);
                
                let contentHTML = `
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <span class="px-3 py-1 rounded-full ${categoryColor} text-sm">${categoryName}</span>
                                ${knowledge.favorite ? '<span class="px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-400 text-sm"><i class="fa fa-star mr-1"></i>收藏</span>' : ''}
                            </div>
                            <div class="text-sm text-slate-400">
                                创建于：${formatDate(knowledge.createdAt)}
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="text-lg font-medium mb-2">描述</h4>
                            <p class="text-slate-300">${knowledge.description || '暂无描述'}</p>
                        </div>
                `;
                
                if (knowledge.tags && knowledge.tags.length > 0) {
                    contentHTML += `
                        <div class="mb-6">
                            <h4 class="text-lg font-medium mb-2">标签</h4>
                            <div class="flex flex-wrap gap-2">
                                ${knowledge.tags.map(tag => `
                                    <span class="knowledge-tag">${escapeHtml(tag)}</span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                if (knowledge.source) {
                    contentHTML += `
                        <div class="mb-6">
                            <h4 class="text-lg font-medium mb-2">来源</h4>
                            <p class="text-slate-300">${escapeHtml(knowledge.source)}</p>
                        </div>
                    `;
                }
                
                if (knowledge.link) {
                    contentHTML += `
                        <div class="mb-6">
                            <h4 class="text-lg font-medium mb-2">参考链接</h4>
                            <a href="${knowledge.link}" target="_blank" class="text-blue-400 hover:text-blue-300 break-all">
                                ${escapeHtml(knowledge.link)}
                            </a>
                        </div>
                    `;
                }
                
                contentHTML += `
                    <div class="mb-6">
                        <h4 class="text-lg font-medium mb-2">内容</h4>
                        <div class="knowledge-content">
                            ${renderMarkdown(knowledge.content)}
                        </div>
                    </div>
                `;
                
                contentElement.innerHTML = contentHTML;
                
                // 设置编辑按钮的事件
                editKnowledgeDetailBtn.onclick = () => {
                    closeKnowledgeDetailModal();
                    setTimeout(() => {
                        openKnowledgeModal(knowledge);
                    }, 300);
                };
                
                knowledgeDetailModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
            
            // 关闭知识详情模态框
            function closeKnowledgeDetailModal() {
                knowledgeDetailModal.classList.add('hidden');
                document.body.style.overflow = '';
            }
            
            // 事件监听
            createKnowledgeBtn.addEventListener('click', () => openKnowledgeModal());
            createFirstKnowledgeBtn.addEventListener('click', () => openKnowledgeModal());
            
            closeKnowledgeModalBtn.addEventListener('click', closeKnowledgeModal);
            cancelKnowledgeBtn.addEventListener('click', closeKnowledgeModal);
            knowledgeModalOverlay.addEventListener('click', closeKnowledgeModal);
            
            closeKnowledgeDetailBtn.addEventListener('click', closeKnowledgeDetailModal);
            closeKnowledgeDetailModalBtn.addEventListener('click', closeKnowledgeDetailModal);
            knowledgeDetailOverlay.addEventListener('click', closeKnowledgeDetailModal);
            
            // 标签输入
            knowledgeTagsInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const tag = this.value.trim();
                    if (tag && !isKnowledgeTagExists(tag)) {
                        addTagToKnowledgeContainer(tag);
                        this.value = '';
                    }
                }
            });
            
            addTagBtn.addEventListener('click', function() {
                const tag = knowledgeTagsInput.value.trim();
                if (tag && !isKnowledgeTagExists(tag)) {
                    addTagToKnowledgeContainer(tag);
                    knowledgeTagsInput.value = '';
                }
            });
            
            function isKnowledgeTagExists(tag) {
                const existingTags = Array.from(knowledgeTagsContainer.querySelectorAll('.knowledge-tag'));
                return existingTags.some(t => t.textContent === tag);
            }
            
            function addTagToKnowledgeContainer(tag) {
                const tagElement = document.createElement('span');
                tagElement.className = 'knowledge-tag';
                tagElement.textContent = tag;
                tagElement.innerHTML = tag + ' <i class="fa fa-times ml-1 cursor-pointer"></i>';
                
                tagElement.querySelector('.fa-times').addEventListener('click', function(e) {
                    e.stopPropagation();
                    tagElement.remove();
                });
                
                knowledgeTagsContainer.appendChild(tagElement);
            }
            
            // 预设标签点击事件
            document.querySelectorAll('.tag-suggestion').forEach(suggestion => {
                suggestion.addEventListener('click', function() {
                    const tag = this.getAttribute('data-tag');
                    if (!isKnowledgeTagExists(tag)) {
                        addTagToKnowledgeContainer(tag);
                    }
                });
            });
            
            // 内容预览
            knowledgeContent.addEventListener('input', function() {
                updateKnowledgePreview();
            });
            
            function updateKnowledgePreview() {
                const content = knowledgeContent.value;
                if (content.trim()) {
                    knowledgePreview.innerHTML = renderMarkdown(content.substring(0, 500) + (content.length > 500 ? '...' : ''));
                } else {
                    knowledgePreview.textContent = '内容预览将在这里显示...';
                }
            }
            
            // 表单提交
            knowledgeForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const knowledgeData = {
                    id: formData.get('id') ? parseInt(formData.get('id')) : Date.now(),
                    title: formData.get('title'),
                    description: formData.get('description'),
                    category: formData.get('category'),
                    content: formData.get('content'),
                    source: formData.get('source'),
                    link: formData.get('link'),
                    favorite: formData.get('favorite') === 'on',
                    public: formData.get('public') === 'on',
                    shareable: formData.get('shareable') === 'on',
                    createdAt: formData.get('createdAt') || new Date().toISOString().split('T')[0],
                    updatedAt: new Date().toISOString().split('T')[0]
                };
                
                // 获取标签
                const tags = Array.from(knowledgeTagsContainer.querySelectorAll('.knowledge-tag'))
                    .map(tag => tag.textContent.replace(' ×', ''));
                knowledgeData.tags = tags;
                
                if (knowledgeData.id && isNaN(knowledgeData.id)) {
                    knowledgeData.id = Date.now();
                }
                
                // 保存知识
                if (formData.get('id')) {
                    // 更新现有知识
                    const index = AppState.knowledge.findIndex(k => k.id === knowledgeData.id);
                    if (index !== -1) {
                        AppState.knowledge[index] = knowledgeData;
                        showNotification('知识已更新', 'success');
                    }
                } else {
                    // 添加新知识
                    AppState.knowledge.unshift(knowledgeData);
                    showNotification('知识已创建', 'success');
                }
                
                saveState();
                loadKnowledge();
                closeKnowledgeModal();
            });
            
            // 知识库筛选
            knowledgeFilterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const filter = this.dataset.filter;
                    
                    // 更新按钮状态
                    knowledgeFilterBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 更新筛选状态
                    AppState.knowledgeFilters.current = filter;
                    loadKnowledge();
                });
            });
            
            // 知识搜索
            let searchTimeout;
            knowledgeSearchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    AppState.knowledgeFilters.searchQuery = this.value.trim();
                    loadKnowledge();
                }, 300);
            });
            
            // 知识分类卡片点击
            knowledgeCategoryCards.forEach(card => {
                card.addEventListener('click', function() {
                    const category = this.dataset.category;
                    
                    // 更新筛选状态
                    knowledgeFilterBtns.forEach(b => b.classList.remove('active'));
                    AppState.knowledgeFilters.current = category;
                    loadKnowledge();
                });
            });
            
            // 初始加载示例知识（如果没有知识）
            if (AppState.knowledge.length === 0) {
                AppState.knowledge = [...sampleKnowledge];
                saveState();
            }
        }
        
        // 加载和渲染知识库
        function loadKnowledge() {
            const knowledgeListContainer = document.getElementById('knowledge-list-container');
            const emptyState = document.getElementById('knowledge-empty-state');
            const knowledgeTotalCount = document.getElementById('knowledge-total-count');
            const today = new Date().toISOString().split('T')[0];
            
            // 筛选知识
            let filteredKnowledge = [...AppState.knowledge];
            const filter = AppState.knowledgeFilters.current;
            const searchQuery = AppState.knowledgeFilters.searchQuery.toLowerCase();
            
            // 应用筛选器
            if (filter !== 'all') {
                switch (filter) {
                    case 'technology':
                    case 'learning':
                    case 'work':
                    case 'life':
                        filteredKnowledge = filteredKnowledge.filter(k => k.category === filter);
                        break;
                    case 'recent':
                        filteredKnowledge = filteredKnowledge.filter(k => k.createdAt === today);
                        break;
                    case 'favorite':
                        filteredKnowledge = filteredKnowledge.filter(k => k.favorite);
                        break;
                }
            }
            
            // 应用搜索
            if (searchQuery) {
                filteredKnowledge = filteredKnowledge.filter(k => 
                    k.title.toLowerCase().includes(searchQuery) ||
                    k.description.toLowerCase().includes(searchQuery) ||
                    k.content.toLowerCase().includes(searchQuery) ||
                    (k.tags && k.tags.some(tag => tag.toLowerCase().includes(searchQuery)))
                );
            }
            
            // 更新统计
            updateKnowledgeStats();
            
            // 更新总数显示
            knowledgeTotalCount.textContent = filteredKnowledge.length;
            
            // 渲染知识列表
            if (filteredKnowledge.length === 0) {
                knowledgeListContainer.innerHTML = '';
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                knowledgeListContainer.innerHTML = '';
                
                filteredKnowledge.forEach(knowledge => {
                    const knowledgeElement = createKnowledgeElement(knowledge);
                    knowledgeListContainer.appendChild(knowledgeElement);
                });
            }
        }
        
        // 创建知识元素
        function createKnowledgeElement(knowledge) {
            const today = new Date().toISOString().split('T')[0];
            const isToday = knowledge.createdAt === today;
            
            const knowledgeElement = document.createElement('div');
            knowledgeElement.className = 'knowledge-item-card knowledge-fade-in';
            knowledgeElement.dataset.id = knowledge.id;
            
            const categoryName = getKnowledgeCategoryName(knowledge.category);
            const categoryColor = getKnowledgeCategoryColor(knowledge.category);
            
            knowledgeElement.innerHTML = `
                <div class="knowledge-item-header">
                    <div class="flex-1">
                        <h4 class="font-semibold text-lg mb-1">${escapeHtml(knowledge.title)}</h4>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 rounded-full ${categoryColor} text-xs">${categoryName}</span>
                            ${isToday ? '<span class="px-2 py-1 rounded-full bg-green-500/20 text-green-400 text-xs">今日新增</span>' : ''}
                            ${knowledge.favorite ? '<span class="px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-400 text-xs"><i class="fa fa-star"></i></span>' : ''}
                        </div>
                    </div>
                    <div class="text-sm text-slate-400">
                        ${formatDate(knowledge.createdAt)}
                    </div>
                </div>
                
                <p class="text-sm text-slate-300 mb-3">${escapeHtml(knowledge.description || '暂无描述')}</p>
                
                ${knowledge.tags && knowledge.tags.length > 0 ? `
                    <div class="knowledge-item-tags">
                        ${knowledge.tags.slice(0, 5).map(tag => `
                            <span class="knowledge-tag">${escapeHtml(tag)}</span>
                        `).join('')}
                        ${knowledge.tags.length > 5 ? `<span class="text-xs text-slate-500">+${knowledge.tags.length - 5}</span>` : ''}
                    </div>
                ` : ''}
                
                <div class="knowledge-actions">
                    <button class="knowledge-action-btn primary" data-action="view" data-id="${knowledge.id}">
                        <i class="fa fa-eye"></i>查看详情
                    </button>
                    <button class="knowledge-action-btn secondary" data-action="edit" data-id="${knowledge.id}">
                        <i class="fa fa-edit"></i>编辑
                    </button>
                    <button class="knowledge-action-btn secondary" data-action="copy" data-id="${knowledge.id}">
                        <i class="fa fa-copy"></i>复制
                    </button>
                    <button class="knowledge-action-btn secondary" data-action="${knowledge.favorite ? 'unfavorite' : 'favorite'}" data-id="${knowledge.id}">
                        <i class="fa ${knowledge.favorite ? 'fa-star' : 'fa-star-o'}"></i>${knowledge.favorite ? '取消收藏' : '收藏'}
                    </button>
                </div>
            `;
            
            // 添加事件监听器
            const viewBtn = knowledgeElement.querySelector('[data-action="view"]');
            const editBtn = knowledgeElement.querySelector('[data-action="edit"]');
            const copyBtn = knowledgeElement.querySelector('[data-action="copy"]');
            const favoriteBtn = knowledgeElement.querySelector('[data-action="favorite"], [data-action="unfavorite"]');
            
            viewBtn.addEventListener('click', function() {
                const knowledgeId = parseInt(this.dataset.id);
                const knowledgeItem = AppState.knowledge.find(k => k.id === knowledgeId);
                if (knowledgeItem) {
                    openKnowledgeDetailModal(knowledgeItem);
                }
            });
            
            editBtn.addEventListener('click', function() {
                const knowledgeId = parseInt(this.dataset.id);
                const knowledgeItem = AppState.knowledge.find(k => k.id === knowledgeId);
                if (knowledgeItem) {
                    openKnowledgeModal(knowledgeItem);
                }
            });
            
            copyBtn.addEventListener('click', function() {
                const knowledgeId = parseInt(this.dataset.id);
                const knowledgeItem = AppState.knowledge.find(k => k.id === knowledgeId);
                if (knowledgeItem) {
                    const text = `标题：${knowledgeItem.title}\n\n描述：${knowledgeItem.description}\n\n内容：${knowledgeItem.content}`;
                    navigator.clipboard.writeText(text).then(() => {
                        showNotification('知识内容已复制到剪贴板', 'success');
                    });
                }
            });
            
            favoriteBtn.addEventListener('click', function() {
                const knowledgeId = parseInt(this.dataset.id);
                toggleKnowledgeFavorite(knowledgeId);
            });
            
            return knowledgeElement;
        }
        
        // 更新知识库统计
        function updateKnowledgeStats() {
            const today = new Date().toISOString().split('T')[0];
            
            const totalKnowledge = AppState.knowledge.length;
            const todayKnowledge = AppState.knowledge.filter(k => k.createdAt === today).length;
            
            // 计算分类统计
            const categoryCounts = {};
            AppState.knowledgeCategories.forEach(category => {
                categoryCounts[category] = AppState.knowledge.filter(k => k.category === category).length;
            });
            
            // 计算标签统计
            const tagCounts = {};
            AppState.knowledge.forEach(k => {
                if (k.tags) {
                    k.tags.forEach(tag => {
                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                    });
                }
            });
            
            // 更新显示
            document.getElementById('total-knowledge-count').textContent = totalKnowledge;
            document.getElementById('today-knowledge-count').textContent = todayKnowledge;
            document.getElementById('categories-count').textContent = AppState.knowledgeCategories.length;
            document.getElementById('tags-count').textContent = Object.keys(tagCounts).length;
            
            // 更新分类计数
            document.getElementById('tech-count').textContent = categoryCounts.technology + ' 条知识';
            document.getElementById('learning-count').textContent = categoryCounts.learning + ' 条知识';
            document.getElementById('work-count').textContent = categoryCounts.work + ' 条知识';
            document.getElementById('life-count').textContent = categoryCounts.life + ' 条知识';
            
            // 更新状态
            AppState.stats.knowledgeStats = {
                total: totalKnowledge,
                today: todayKnowledge,
                categories: categoryCounts,
                tags: tagCounts
            };
        }
        
        // 切换知识收藏状态
        function toggleKnowledgeFavorite(knowledgeId) {
            const knowledgeIndex = AppState.knowledge.findIndex(k => k.id === knowledgeId);
            if (knowledgeIndex === -1) return;
            
            const knowledge = AppState.knowledge[knowledgeIndex];
            knowledge.favorite = !knowledge.favorite;
            knowledge.updatedAt = new Date().toISOString().split('T')[0];
            
            AppState.knowledge[knowledgeIndex] = knowledge;
            saveState();
            loadKnowledge();
            
            showNotification(knowledge.favorite ? '已添加到收藏' : '已取消收藏', 'success');
        }
        
        // 获取知识分类名称
        function getKnowledgeCategoryName(category) {
            const categories = {
                'technology': '技术知识',
                'learning': '学习笔记',
                'work': '工作文档',
                'life': '生活经验',
                'other': '其他'
            };
            return categories[category] || category;
        }
        
        // 获取知识分类颜色
        function getKnowledgeCategoryColor(category) {
            const colors = {
                'technology': 'bg-blue-500/20 text-blue-400',
                'learning': 'bg-green-500/20 text-green-400',
                'work': 'bg-purple-500/20 text-purple-400',
                'life': 'bg-orange-500/20 text-orange-400',
                'other': 'bg-slate-500/20 text-slate-400'
            };
            return colors[category] || colors.other;
        }
        
        // 渲染Markdown内容
        function renderMarkdown(text) {
            // 简单Markdown渲染
            let html = escapeHtml(text);
            
            // 标题
            html = html.replace(/^### (.*$)/gm, '<h3 class="text-lg font-bold mt-4 mb-2">$1</h3>');
            html = html.replace(/^## (.*$)/gm, '<h2 class="text-xl font-bold mt-6 mb-3">$1</h2>');
            html = html.replace(/^# (.*$)/gm, '<h1 class="text-2xl font-bold mt-8 mb-4">$1</h1>');
            
            // 粗体
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // 斜体
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // 列表
            html = html.replace(/^- (.*$)/gm, '<li class="ml-4">$1</li>');
            html = html.replace(/(<li.*<\/li>)/g, '<ul class="list-disc ml-6 my-2">$1</ul>');
            
            // 代码块
            html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre class="bg-slate-800/50 p-4 rounded-lg overflow-x-auto my-3"><code>$2</code></pre>');
            html = html.replace(/`([^`]+)`/g, '<code class="bg-slate-800/50 px-1 rounded">$1</code>');
            
            // 链接
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-blue-400 hover:text-blue-300">$1</a>');
            
            // 段落
            html = html.replace(/\n\n/g, '</p><p class="my-3">');
            html = '<p class="my-3">' + html + '</p>';
            
            return html;
        }
        
        // 初始化任务组件
        function initTaskComponents() {
            // 任务按钮
            const createTaskBtn = document.getElementById('create-task-btn');
            const createFirstTaskBtn = document.getElementById('create-first-task-btn');
            const taskModal = document.getElementById('task-modal');
            const taskModalOverlay = document.getElementById('task-modal-overlay');
            const closeTaskModalBtn = document.getElementById('close-task-modal-btn');
            const cancelTaskBtn = document.getElementById('cancel-task-btn');
            const taskForm = document.getElementById('task-form');
            const taskProgress = document.getElementById('task-progress');
            const progressValue = document.getElementById('progress-value');
            const taskTagsInput = document.getElementById('task-tags-input');
            const taskTagsContainer = document.getElementById('task-tags-container');
            
            // 任务筛选按钮
            const taskFilterBtns = document.querySelectorAll('.task-filter-btn');
            
            // 打开任务模态框
            function openTaskModal(task = null) {
                const titleElement = document.getElementById('task-modal-title');
                const form = document.getElementById('task-form');
                const tagsContainer = document.getElementById('task-tags-container');
                
                if (task) {
                    // 编辑模式
                    titleElement.textContent = '编辑任务';
                    document.getElementById('task-id').value = task.id;
                    document.getElementById('task-title').value = task.title;
                    document.getElementById('task-description').value = task.description || '';
                    document.getElementById('task-priority').value = task.priority;
                    document.getElementById('task-category').value = task.category;
                    document.getElementById('task-due-date').value = task.dueDate;
                    document.getElementById('task-progress').value = task.progress;
                    document.getElementById('progress-value').textContent = task.progress + '%';
                    document.getElementById('task-important').checked = task.important;
                    
                    // 设置标签
                    tagsContainer.innerHTML = '';
                    if (task.tags && task.tags.length > 0) {
                        task.tags.forEach(tag => {
                            const tagElement = document.createElement('span');
                            tagElement.className = 'task-tag';
                            tagElement.textContent = tag;
                            tagElement.dataset.tag = tag;
                            tagElement.innerHTML = tag + ' <i class="fa fa-times ml-1 cursor-pointer"></i>';
                            tagsContainer.appendChild(tagElement);
                        });
                    }
                } else {
                    // 创建模式
                    titleElement.textContent = '新建任务';
                    form.reset();
                    document.getElementById('task-id').value = '';
                    document.getElementById('progress-value').textContent = '0%';
                    document.getElementById('task-progress').value = 0;
                    tagsContainer.innerHTML = '';
                }
                
                // 添加标签删除事件
                tagsContainer.querySelectorAll('.fa-times').forEach(icon => {
                    icon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const tagElement = this.parentElement;
                        tagElement.remove();
                    });
                });
                
                taskModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                document.getElementById('task-title').focus();
            }
            
            // 关闭任务模态框
            function closeTaskModal() {
                taskModal.classList.add('hidden');
                document.body.style.overflow = '';
            }
            
            // 事件监听
            createTaskBtn.addEventListener('click', () => openTaskModal());
            createFirstTaskBtn.addEventListener('click', () => openTaskModal());
            
            closeTaskModalBtn.addEventListener('click', closeTaskModal);
            cancelTaskBtn.addEventListener('click', closeTaskModal);
            taskModalOverlay.addEventListener('click', closeTaskModal);
            
            // 进度滑块
            taskProgress.addEventListener('input', function() {
                progressValue.textContent = this.value + '%';
            });
            
            // 标签输入
            taskTagsInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const tag = this.value.trim();
                    if (tag && !isTagExists(tag)) {
                        addTagToContainer(tag);
                        this.value = '';
                    }
                }
            });
            
            function isTagExists(tag) {
                const existingTags = Array.from(taskTagsContainer.querySelectorAll('.task-tag'));
                return existingTags.some(t => t.dataset.tag === tag);
            }
            
            function addTagToContainer(tag) {
                const tagElement = document.createElement('span');
                tagElement.className = 'task-tag';
                tagElement.textContent = tag;
                tagElement.dataset.tag = tag;
                tagElement.innerHTML = tag + ' <i class="fa fa-times ml-1 cursor-pointer"></i>';
                
                tagElement.querySelector('.fa-times').addEventListener('click', function(e) {
                    e.stopPropagation();
                    tagElement.remove();
                });
                
                taskTagsContainer.appendChild(tagElement);
            }
            
            // 预设标签点击事件
            document.querySelectorAll('.task-tag-suggestion').forEach(suggestion => {
                suggestion.addEventListener('click', function() {
                    const tag = this.textContent;
                    if (!isTagExists(tag)) {
                        addTagToContainer(tag);
                    }
                });
            });
            
            // 表单提交
            taskForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const taskData = {
                    id: formData.get('id') ? parseInt(formData.get('id')) : Date.now(),
                    title: formData.get('title'),
                    description: formData.get('description'),
                    priority: formData.get('priority'),
                    category: formData.get('category'),
                    dueDate: formData.get('dueDate'),
                    progress: parseInt(formData.get('progress')),
                    important: formData.get('important') === 'on',
                    completed: parseInt(formData.get('progress')) === 100,
                    createdAt: new Date().toISOString().split('T')[0],
                    completedAt: parseInt(formData.get('progress')) === 100 ? 
                        new Date().toISOString().split('T')[0] : null
                };
                
                // 获取标签
                const tags = Array.from(taskTagsContainer.querySelectorAll('.task-tag'))
                    .map(tag => tag.dataset.tag);
                taskData.tags = tags;
                
                if (taskData.id && isNaN(taskData.id)) {
                    taskData.id = Date.now();
                }
                
                // 保存任务
                if (formData.get('id')) {
                    // 更新现有任务
                    const index = AppState.tasks.findIndex(t => t.id === taskData.id);
                    if (index !== -1) {
                        AppState.tasks[index] = taskData;
                        showNotification('任务已更新', 'success');
                    }
                } else {
                    // 添加新任务
                    AppState.tasks.unshift(taskData);
                    showNotification('任务已创建', 'success');
                }
                
                saveState();
                loadTasks();
                closeTaskModal();
            });
            
            // 任务筛选
            taskFilterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const filter = this.dataset.filter;
                    
                    // 更新按钮状态
                    taskFilterBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 更新筛选状态
                    AppState.taskFilters.current = filter;
                    loadTasks();
                });
            });
            
            // 初始加载示例任务（如果没有任务）
            if (AppState.tasks.length === 0) {
                AppState.tasks = [...sampleTasks];
                saveState();
            }
        }
        
        // 加载和渲染任务
        function loadTasks() {
            const tasksListContainer = document.getElementById('tasks-list-container');
            const emptyState = document.getElementById('tasks-empty-state');
            
            // 筛选任务
            let filteredTasks = [...AppState.tasks];
            const today = new Date().toISOString().split('T')[0];
            
            switch (AppState.taskFilters.current) {
                case 'today':
                    filteredTasks = filteredTasks.filter(task => task.dueDate === today);
                    break;
                case 'completed':
                    filteredTasks = filteredTasks.filter(task => task.completed);
                    break;
                case 'pending':
                    filteredTasks = filteredTasks.filter(task => !task.completed);
                    break;
                case 'overdue':
                    filteredTasks = filteredTasks.filter(task => 
                        task.dueDate && task.dueDate < today && !task.completed
                    );
                    break;
                case 'important':
                    filteredTasks = filteredTasks.filter(task => task.important);
                    break;
                case 'all':
                default:
                    break;
            }
            
            // 更新统计
            updateTaskStats();
            
            // 渲染任务列表
            if (filteredTasks.length === 0) {
                tasksListContainer.innerHTML = '';
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                tasksListContainer.innerHTML = '';
                
                filteredTasks.forEach(task => {
                    const taskElement = createTaskElement(task);
                    tasksListContainer.appendChild(taskElement);
                });
            }
        }
        
        // 创建任务元素
        function createTaskElement(task) {
            const today = new Date().toISOString().split('T')[0];
            const isOverdue = task.dueDate && task.dueDate < today && !task.completed;
            const isToday = task.dueDate === today;
            
            const taskElement = document.createElement('div');
            taskElement.className = `task-card task-fade-in ${task.completed ? 'completed' : ''} ${task.important ? 'important' : ''} ${isOverdue ? 'overdue' : ''}`;
            
            // 优先级文本和颜色
            let priorityText = '';
            let priorityClass = '';
            switch(task.priority) {
                case 'high':
                    priorityText = '高优先级';
                    priorityClass = 'priority-high';
                    break;
                case 'medium':
                    priorityText = '中优先级';
                    priorityClass = 'priority-medium';
                    break;
                case 'low':
                    priorityText = '低优先级';
                    priorityClass = 'priority-low';
                    break;
            }
            
            // 分类图标
            let categoryIcon = '';
            switch(task.category) {
                case 'work':
                    categoryIcon = 'fa-briefcase';
                    break;
                case 'study':
                    categoryIcon = 'fa-graduation-cap';
                    break;
                case 'personal':
                    categoryIcon = 'fa-user';
                    break;
                case 'health':
                    categoryIcon = 'fa-heartbeat';
                    break;
                default:
                    categoryIcon = 'fa-tasks';
            }
            
            taskElement.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center mb-2">
                            <div class="task-checkbox ${task.completed ? 'checked' : ''}" 
                                 data-task-id="${task.id}">
                                ${task.completed ? '<i class="fa fa-check"></i>' : ''}
                            </div>
                            <h3 class="font-medium text-lg ml-3 ${task.completed ? 'line-through text-slate-400' : 'text-slate-200'}">
                                ${escapeHtml(task.title)}
                            </h3>
                        </div>
                        
                        ${task.description ? `<p class="text-sm text-slate-300 mb-3 ml-9">${escapeHtml(task.description)}</p>` : ''}
                        
                        <div class="ml-9">
                            <div class="flex flex-wrap items-center gap-2 mb-3">
                                <span class="${priorityClass} task-priority">
                                    ${priorityText}
                                </span>
                                <span class="text-sm text-slate-400">
                                    <i class="fa ${categoryIcon} mr-1"></i>
                                    ${getCategoryName(task.category)}
                                </span>
                                ${task.dueDate ? `
                                    <span class="task-date ${isOverdue ? 'text-red-400' : ''} ${isToday ? 'text-yellow-400' : ''}">
                                        <i class="fa fa-calendar ${isOverdue ? 'text-red-400' : ''}"></i>
                                        ${formatDate(task.dueDate)}
                                        ${isOverdue ? ' (已逾期)' : ''}
                                        ${isToday ? ' (今天)' : ''}
                                    </span>
                                ` : ''}
                            </div>
                            
                            ${task.tags && task.tags.length > 0 ? `
                                <div class="flex flex-wrap gap-2 mb-3">
                                    ${task.tags.map(tag => `
                                        <span class="task-tag">${escapeHtml(tag)}</span>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <div class="task-progress">
                                <div class="task-progress-bar progress-animation" 
                                     style="width: ${task.progress}%">
                                </div>
                            </div>
                            <div class="flex justify-between text-xs text-slate-400 mt-1">
                                <span>进度 ${task.progress}%</span>
                                ${task.completedAt ? `
                                    <span>完成于：${formatDate(task.completedAt)}</span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="task-actions ml-4 flex space-x-1">
                        <button class="task-action-btn edit" data-task-id="${task.id}" title="编辑">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button class="task-action-btn delete" data-task-id="${task.id}" title="删除">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // 添加事件监听器
            const checkbox = taskElement.querySelector('.task-checkbox');
            const editBtn = taskElement.querySelector('.task-action-btn.edit');
            const deleteBtn = taskElement.querySelector('.task-action-btn.delete');
            
            checkbox.addEventListener('click', function() {
                toggleTaskComplete(task.id);
            });
            
            editBtn.addEventListener('click', function() {
                const taskToEdit = AppState.tasks.find(t => t.id === task.id);
                if (taskToEdit) {
                    openTaskModal(taskToEdit);
                }
            });
            
            deleteBtn.addEventListener('click', function() {
                if (confirm('确定要删除这个任务吗？')) {
                    deleteTask(task.id);
                }
            });
            
            return taskElement;
        }
        
        // 更新任务统计
        function updateTaskStats() {
            const today = new Date().toISOString().split('T')[0];
            
            const totalTasks = AppState.tasks.length;
            const completedTasks = AppState.tasks.filter(task => task.completed).length;
            const todayTasks = AppState.tasks.filter(task => task.dueDate === today).length;
            const overdueTasks = AppState.tasks.filter(task => 
                task.dueDate && task.dueDate < today && !task.completed
            ).length;
            
            document.getElementById('total-tasks-count').textContent = totalTasks;
            document.getElementById('completed-tasks-count').textContent = completedTasks;
            document.getElementById('today-tasks-count').textContent = todayTasks;
            document.getElementById('overdue-tasks-count').textContent = overdueTasks;
        }
        
        // 切换任务完成状态
        function toggleTaskComplete(taskId) {
            const taskIndex = AppState.tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            const task = AppState.tasks[taskIndex];
            const wasCompleted = task.completed;
            
            task.completed = !task.completed;
            task.progress = task.completed ? 100 : Math.max(0, task.progress - 10);
            task.completedAt = task.completed ? new Date().toISOString().split('T')[0] : null;
            
            if (task.completed && !wasCompleted) {
                showNotification('任务已完成！', 'success');
                
                // 添加完成动画
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`).closest('.task-card');
                taskElement.classList.add('task-check-animation');
                setTimeout(() => {
                    taskElement.classList.remove('task-check-animation');
                }, 300);
            }
            
            AppState.tasks[taskIndex] = task;
            saveState();
            loadTasks();
        }
        
        // 删除任务
        function deleteTask(taskId) {
            AppState.tasks = AppState.tasks.filter(task => task.id !== taskId);
            saveState();
            loadTasks();
            showNotification('任务已删除', 'success');
        }
        
        // 获取分类名称
        function getCategoryName(category) {
            const categories = {
                'work': '工作',
                'study': '学习',
                'personal': '个人',
                'health': '健康',
                'other': '其他'
            };
            return categories[category] || category;
        }
        
        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            if (date.toDateString() === today.toDateString()) {
                return '今天';
            } else if (date.toDateString() === tomorrow.toDateString()) {
                return '明天';
            } else {
                return date.toLocaleDateString('zh-CN', {
                    month: 'short',
                    day: 'numeric',
                    year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
                });
            }
        }
        
        // 初始化侧边栏折叠功能（修复版，无抖动）
        function initSidebarToggle() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarContainer = document.getElementById('sidebar-container');
            const mobileSidebarOverlay = document.getElementById('mobile-sidebar-overlay');
            
            if (!sidebar || !sidebarToggle || !sidebarContainer) return;
            
            // 从状态加载侧边栏状态
            if (AppState.settings.sidebarCollapsed) {
                collapseSidebar();
            } else {
                expandSidebar();
            }
            
            // 点击切换按钮
            sidebarToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                if (isSidebarAnimating) return;
                
                if (AppState.settings.sidebarCollapsed) {
                    expandSidebar();
                } else {
                    collapseSidebar();
                }
            });
            
            function collapseSidebar() {
                if (isSidebarAnimating) return;
                isSidebarAnimating = true;
                
                // 桌面端逻辑
                if (window.innerWidth >= 769) {
                    sidebar.classList.add('collapsed');
                    sidebarContainer.classList.add('collapsed');
                    
                    // 更新按钮状态
                    sidebarToggle.classList.add('collapsed');
                    sidebarToggle.innerHTML = '<i class="fa fa-chevron-right"></i>';
                    sidebarToggle.setAttribute('data-tooltip', '展开侧边栏');
                    
                    // 保存状态
                    AppState.settings.sidebarCollapsed = true;
                    saveState();
                    
                    // 动画完成后重置标志
                    setTimeout(() => {
                        isSidebarAnimating = false;
                    }, 300);
                } else {
                    // 移动端逻辑
                    sidebarContainer.classList.remove('active');
                    mobileSidebarOverlay.classList.remove('active');
                    
                    // 保存状态
                    AppState.settings.sidebarCollapsed = true;
                    saveState();
                    
                    isSidebarAnimating = false;
                }
            }
            
            function expandSidebar() {
                if (isSidebarAnimating) return;
                isSidebarAnimating = true;
                
                // 桌面端逻辑
                if (window.innerWidth >= 769) {
                    sidebar.classList.remove('collapsed');
                    sidebarContainer.classList.remove('collapsed');
                    
                    // 更新按钮状态
                    sidebarToggle.classList.remove('collapsed');
                    sidebarToggle.innerHTML = '<i class="fa fa-chevron-left"></i>';
                    sidebarToggle.setAttribute('data-tooltip', '收起侧边栏');
                    
                    // 保存状态
                    AppState.settings.sidebarCollapsed = false;
                    saveState();
                    
                    // 动画完成后重置标志
                    setTimeout(() => {
                        isSidebarAnimating = false;
                    }, 300);
                } else {
                    // 移动端逻辑
                    sidebarContainer.classList.add('active');
                    mobileSidebarOverlay.classList.add('active');
                    
                    // 保存状态
                    AppState.settings.sidebarCollapsed = false;
                    saveState();
                    
                    isSidebarAnimating = false;
                }
            }
            
            // 移动端侧边栏切换
            const sidebarToggleMobile = document.getElementById('sidebar-toggle-mobile');
            if (sidebarToggleMobile) {
                sidebarToggleMobile.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (window.innerWidth < 769) {
                        expandSidebar();
                    } else {
                        const modal = document.getElementById('mobile-commands-modal');
                        modal.classList.remove('hidden');
                        document.body.style.overflow = 'hidden';
                    }
                });
            }
            
            // 移动端遮罩点击关闭
            if (mobileSidebarOverlay) {
                mobileSidebarOverlay.addEventListener('click', function() {
                    collapseSidebar();
                });
            }
            
            // 窗口调整时重新布局
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    // 移动端隐藏侧边栏切换按钮
                    if (window.innerWidth < 769) {
                        sidebarToggle.style.display = 'none';
                        // 确保侧边栏在移动端是隐藏的
                        sidebarContainer.classList.remove('active');
                        mobileSidebarOverlay.classList.remove('active');
                        sidebar.classList.remove('collapsed');
                        sidebarContainer.classList.remove('collapsed');
                    } else {
                        sidebarToggle.style.display = 'flex';
                        sidebarContainer.classList.remove('active');
                        mobileSidebarOverlay.classList.remove('active');
                        
                        // 恢复桌面端状态
                        if (AppState.settings.sidebarCollapsed) {
                            sidebar.classList.add('collapsed');
                            sidebarContainer.classList.add('collapsed');
                            sidebarToggle.classList.add('collapsed');
                            sidebarToggle.innerHTML = '<i class="fa fa-chevron-right"></i>';
                        } else {
                            sidebar.classList.remove('collapsed');
                            sidebarContainer.classList.remove('collapsed');
                            sidebarToggle.classList.remove('collapsed');
                            sidebarToggle.innerHTML = '<i class="fa fa-chevron-left"></i>';
                        }
                    }
                }, 150);
            });
            
            // 初始化响应式状态
            if (window.innerWidth < 769) {
                sidebarToggle.style.display = 'none';
                sidebarContainer.classList.remove('active');
                mobileSidebarOverlay.classList.remove('active');
            }
        }
        
        // 初始化聊天组件
        function initChatComponents() {
            // 消息输入
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const chatMessages = document.getElementById('chat-messages');
            const charCount = document.getElementById('char-count');
            
            // 自动调整输入框高度
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                const maxHeight = 150;
                this.style.height = Math.min(this.scrollHeight, maxHeight) + 'px';
                
                const count = this.value.length;
                charCount.textContent = `${count}/1000`;
                if (count > 1000) {
                    charCount.classList.add('text-red-400');
                } else {
                    charCount.classList.remove('text-red-400');
                }
            });
            
            // 发送消息
            async function sendMessage() {
                const message = messageInput.value.trim();
                
                if (!message || message.length > 1000) {
                    showNotification('消息不能为空且长度不能超过1000字', 'error');
                    return;
                }
                
                addMessage(message, 'user');
                messageInput.value = '';
                messageInput.style.height = 'auto';
                document.getElementById('char-count').textContent = '0/1000';
                
                showTypingIndicator();
                
                const userMessage = {
                    id: Date.now(),
                    content: message,
                    sender: 'user',
                    timestamp: new Date(),
                    originalContent: message
                };
                AppState.currentConversation.push(userMessage);
                
                try {
                    const aiResponse = await generateAIResponse(message);
                    
                    removeTypingIndicator();
                    const aiMessageId = Date.now() + 1;
                    addMessage(aiResponse, 'ai', aiMessageId);
                    
                    const aiMessage = {
                        id: aiMessageId,
                        content: aiResponse,
                        sender: 'ai',
                        timestamp: new Date()
                    };
                    AppState.currentConversation.push(aiMessage);
                    
                } catch (error) {
                    removeTypingIndicator();
                    console.error('发送消息失败:', error);
                    
                    const fallbackResponse = getFallbackResponse(message, error.message);
                    const aiMessageId = Date.now() + 1;
                    addMessage(fallbackResponse, 'ai', aiMessageId);
                    
                    const aiMessage = {
                        id: aiMessageId,
                        content: fallbackResponse,
                        sender: 'ai',
                        timestamp: new Date()
                    };
                    AppState.currentConversation.push(aiMessage);
                }
                
                updateStats();
                updateAccountStats();
                saveState();
            }
            
            // 事件监听
            sendBtn.addEventListener('click', sendMessage);
            
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // 语音功能
            let isRecording = false;
            const voiceBtn = document.getElementById('voice-btn');
            const pulseRing = document.getElementById('pulse-ring');
            
            voiceBtn.addEventListener('click', function() {
                if (!isRecording) {
                    startVoiceRecording();
                } else {
                    stopVoiceRecording();
                }
            });
            
            function startVoiceRecording() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    showNotification('您的浏览器不支持语音识别功能', 'warning');
                    return;
                }
                
                isRecording = true;
                pulseRing.classList.remove('hidden');
                voiceBtn.classList.add('recording');
                messageInput.placeholder = "正在聆听...请说话";
                
                setTimeout(() => {
                    const sampleMessages = [
                        "帮我写一封感谢邮件",
                        "Python列表和元组有什么区别",
                        "如何学习人工智能",
                        "今天天气怎么样",
                        "帮我制定一个健身计划",
                        "帮我翻译这段英文"
                    ];
                    
                    const randomMessage = sampleMessages[Math.floor(Math.random() * sampleMessages.length)];
                    messageInput.value = randomMessage;
                    messageInput.dispatchEvent(new Event('input'));
                    
                    stopVoiceRecording();
                    showNotification('语音识别完成', 'success');
                }, 3000);
            }
            
            function stopVoiceRecording() {
                isRecording = false;
                pulseRing.classList.add('hidden');
                voiceBtn.classList.remove('recording');
                messageInput.placeholder = "输入你的问题或指令...（按Enter发送，Shift+Enter换行）";
            }
            
            // 快捷指令
            document.querySelectorAll('.quick-command').forEach(button => {
                button.addEventListener('click', function() {
                    const command = this.getAttribute('data-command');
                    messageInput.value = command;
                    messageInput.dispatchEvent(new Event('input'));
                    messageInput.focus();
                });
            });
            
            // 新对话按钮
            document.getElementById('new-chat-btn').addEventListener('click', function() {
                if (AppState.currentConversation.length > 0) {
                    if (confirm('确定要开始新的对话吗？当前对话将被保存。')) {
                        startNewConversation();
                    }
                } else {
                    startNewConversation();
                }
            });
            
            // 清空对话按钮
            document.getElementById('clear-chat-btn').addEventListener('click', function() {
                if (confirm('确定要清空当前对话吗？')) {
                    chatMessages.innerHTML = '';
                    AppState.currentConversation = [];
                    saveState();
                    showNotification('对话已清空', 'success');
                }
            });
            
            // 导出对话按钮
            document.getElementById('export-chat-btn').addEventListener('click', function() {
                exportConversation();
            });
            
            // 主题切换
            document.getElementById('theme-toggle').addEventListener('click', function() {
                toggleTheme();
            });
            
            // 移动端菜单
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            const mobileOverlay = document.getElementById('mobile-overlay');
            const closeMobileMenu = document.getElementById('close-mobile-menu');
            
            mobileMenuBtn.addEventListener('click', function() {
                mobileMenu.classList.remove('translate-x-[-100%]');
                mobileOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            });
            
            closeMobileMenu.addEventListener('click', closeMobileMenuFunc);
            mobileOverlay.addEventListener('click', closeMobileMenuFunc);
            
            function closeMobileMenuFunc() {
                mobileMenu.classList.add('translate-x-[-100%]');
                mobileOverlay.classList.add('hidden');
                document.body.style.overflow = '';
            }
            
            // 移动端快捷指令
            const mobileCommandsBtn = document.getElementById('mobile-commands-btn');
            const mobileCommandsModal = document.getElementById('mobile-commands-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const modalOverlay = document.getElementById('modal-overlay');
            
            mobileCommandsBtn.addEventListener('click', function() {
                mobileCommandsModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            });
            
            closeModalBtn.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', closeModal);
            
            function closeModal() {
                mobileCommandsModal.classList.add('hidden');
                document.body.style.overflow = '';
            }
            
            // API开关按钮
            const apiToggleBtn = document.createElement('button');
            apiToggleBtn.id = 'api-toggle';
            apiToggleBtn.className = 'p-2 rounded-lg hover:bg-slate-700 transition-colors btn tooltip';
            apiToggleBtn.setAttribute('data-tooltip', AppState.settings.useAPI ? '使用API' : '使用本地回复');
            apiToggleBtn.innerHTML = AppState.settings.useAPI ? 
                '<i class="fa fa-cloud text-green-400"></i>' : 
                '<i class="fa fa-cloud text-gray-400"></i>';
            
            apiToggleBtn.addEventListener('click', function() {
                AppState.settings.useAPI = !AppState.settings.useAPI;
                this.setAttribute('data-tooltip', AppState.settings.useAPI ? '使用API' : '使用本地回复');
                this.innerHTML = AppState.settings.useAPI ? 
                    '<i class="fa fa-cloud text-green-400"></i>' : 
                    '<i class="fa fa-cloud text-gray-400"></i>';
                
                showNotification(AppState.settings.useAPI ? '已切换到API模式' : '已切换到本地模式', 'info');
                saveState();
            });
            
            const buttonGroup = document.querySelector('.flex.items-center.space-x-3');
            if (buttonGroup) {
                buttonGroup.insertBefore(apiToggleBtn, buttonGroup.children[0]);
            }
            
            // AI设置按钮
            const settingsBtn = document.getElementById('settings-btn');
            const aiSettingsModal = document.getElementById('ai-settings-modal');
            const aiSettingsOverlay = document.getElementById('ai-settings-overlay');
            const closeAiSettingsBtn = document.getElementById('close-ai-settings-btn');
            const cancelAiSettingsBtn = document.getElementById('cancel-ai-settings-btn');
            const saveAiSettingsBtn = document.getElementById('save-ai-settings-btn');
            const resetPromptBtn = document.getElementById('reset-prompt-btn');
            
            // AI设置相关元素
            const apiKeyInput = document.getElementById('api-key-input');
            const modelSelect = document.getElementById('model-select');
            const temperatureSlider = document.getElementById('temperature-slider');
            const temperatureValue = document.getElementById('temperature-value');
            const systemPromptInput = document.getElementById('system-prompt-input');
            const promptCharCount = document.getElementById('prompt-char-count');
            const promptPreview = document.getElementById('prompt-preview');
            
            // 打开AI设置模态框
            settingsBtn.addEventListener('click', function() {
                openAISettingsModal();
            });
            
            // 关闭AI设置模态框
            closeAiSettingsBtn.addEventListener('click', closeAISettingsModal);
            cancelAiSettingsBtn.addEventListener('click', closeAISettingsModal);
            aiSettingsOverlay.addEventListener('click', closeAISettingsModal);
            
            function closeAISettingsModal() {
                aiSettingsModal.classList.add('hidden');
                document.body.style.overflow = '';
            }
            
            function openAISettingsModal() {
                apiKeyInput.value = GLM_CONFIG.apiKey;
                modelSelect.value = AppState.settings.model;
                temperatureSlider.value = AppState.settings.temperature;
                temperatureValue.textContent = AppState.settings.temperature;
                systemPromptInput.value = AppState.settings.systemPrompt;
                
                updatePromptCharCount();
                updatePromptPreview();
                
                aiSettingsModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
            
            // 温度滑块
            temperatureSlider.addEventListener('input', function() {
                temperatureValue.textContent = this.value;
            });
            
            // 提示词字符计数
            systemPromptInput.addEventListener('input', function() {
                updatePromptCharCount();
                updatePromptPreview();
            });
            
            function updatePromptCharCount() {
                const count = systemPromptInput.value.length;
                promptCharCount.textContent = `${count}/2000`;
                if (count > 2000) {
                    promptCharCount.classList.add('text-red-400');
                } else {
                    promptCharCount.classList.remove('text-red-400');
                }
            }
            
            function updatePromptPreview() {
                const text = systemPromptInput.value.trim();
                if (text) {
                    promptPreview.textContent = text;
                } else {
                    promptPreview.textContent = '当前系统提示词将显示在这里...';
                }
            }
            
            // 预设提示词选择
            document.querySelectorAll('.preset-tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    const preset = this.getAttribute('data-preset');
                    if (PRESET_PROMPTS[preset]) {
                        systemPromptInput.value = PRESET_PROMPTS[preset];
                        updatePromptCharCount();
                        updatePromptPreview();
                        
                        document.querySelectorAll('.preset-tag').forEach(t => {
                            t.classList.remove('bg-blue-500/20', 'border-blue-500/50');
                        });
                        this.classList.add('bg-blue-500/20', 'border-blue-500/50');
                    }
                });
            });
            
            // 恢复默认提示词
            resetPromptBtn.addEventListener('click', function() {
                systemPromptInput.value = PRESET_PROMPTS.default;
                updatePromptCharCount();
                updatePromptPreview();
                
                document.querySelectorAll('.preset-tag').forEach(t => {
                    t.classList.remove('bg-blue-500/20', 'border-blue-500/50');
                });
                document.querySelector('[data-preset="default"]').classList.add('bg-blue-500/20', 'border-blue-500/50');
            });
            
            // 保存AI设置
            saveAiSettingsBtn.addEventListener('click', function() {
                saveAISettings();
            });
            
            // 快捷键：Ctrl+Shift+S 打开设置
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                    e.preventDefault();
                    openAISettingsModal();
                }
            });
        }
        
        // 保存AI设置
        function saveAISettings() {
            try {
                const apiKey = document.getElementById('api-key-input').value.trim();
                if (apiKey) {
                    GLM_CONFIG.apiKey = apiKey;
                    AppState.settings.apiKey = apiKey;
                }
                
                AppState.settings.model = document.getElementById('model-select').value;
                GLM_CONFIG.model = AppState.settings.model;
                
                AppState.settings.temperature = parseFloat(document.getElementById('temperature-slider').value);
                GLM_CONFIG.temperature = AppState.settings.temperature;
                
                const newPrompt = document.getElementById('system-prompt-input').value.trim();
                if (newPrompt) {
                    AppState.settings.systemPrompt = newPrompt;
                }
                
                saveState();
                document.getElementById('ai-settings-modal').classList.add('hidden');
                document.body.style.overflow = '';
                showNotification('AI设置已保存', 'success');
                
                if (apiKey) {
                    AppState.settings.useAPI = true;
                    const apiToggleBtn = document.getElementById('api-toggle');
                    if (apiToggleBtn) {
                        apiToggleBtn.setAttribute('data-tooltip', '使用API');
                        apiToggleBtn.innerHTML = '<i class="fa fa-cloud text-green-400"></i>';
                    }
                }
                
            } catch (error) {
                console.error('保存AI设置失败:', error);
                showNotification('保存设置失败，请检查输入', 'error');
            }
        }
        
        // 添加消息到聊天界面
        function addMessage(text, sender, messageId = null) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble fade-in ${sender === 'user' ? 'text-right' : ''}`;
            
            if (messageId) {
                messageDiv.setAttribute('data-message-id', messageId);
            } else {
                messageId = Date.now();
                messageDiv.setAttribute('data-message-id', messageId);
            }
            
            const timestamp = new Date().toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            if (sender === 'ai') {
                const feedbackState = AppState.messageFeedback[messageId] || { liked: false, disliked: false };
                messageDiv.innerHTML = `
                    <div class="ai-bubble">
                        <p class="text-sm whitespace-pre-wrap">${escapeHtml(text)}</p>
                        <div class="message-actions mt-2 flex space-x-2">
                            <button class="action-btn copy" data-text="${escapeHtml(text)}">
                                <i class="fa fa-copy"></i>复制
                            </button>
                            <button class="action-btn regenerate">
                                <i class="fa fa-refresh"></i>重新生成
                            </button>
                        </div>
                        <div class="message-feedback">
                            <button class="feedback-btn ${feedbackState.liked ? 'liked' : ''}" data-action="like" data-message-id="${messageId}">
                                <i class="fa fa-thumbs-up"></i>
                            </button>
                            <button class="feedback-btn ${feedbackState.disliked ? 'disliked' : ''}" data-action="dislike" data-message-id="${messageId}">
                                <i class="fa fa-thumbs-down"></i>
                            </button>
                        </div>
                    </div>
                    <div class="message-time mt-2 flex items-center">
                        <i class="fa fa-clock-o text-xs mr-1"></i>
                        <span>${timestamp}</span>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="user-bubble">
                        <p class="text-sm whitespace-pre-wrap">${escapeHtml(text)}</p>
                        <div class="user-message-actions">
                            <button class="user-action-btn copy" data-text="${escapeHtml(text)}">
                                <i class="fa fa-copy"></i>复制
                            </button>
                            <button class="user-action-btn edit">
                                <i class="fa fa-edit"></i>编辑
                            </button>
                        </div>
                        <div class="message-editor">
                            <textarea class="message-edit-input" placeholder="编辑您的消息...">${escapeHtml(text)}</textarea>
                            <div class="message-edit-actions">
                                <button class="message-edit-btn save">保存并重新发送</button>
                                <button class="message-edit-btn cancel">取消</button>
                            </div>
                        </div>
                    </div>
                    <div class="message-time mt-2 flex items-center justify-end">
                        <i class="fa fa-clock-o text-xs mr-1"></i>
                        <span>${timestamp}</span>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            setupMessageEventListeners(messageDiv, sender, messageId);
            
            if (AppState.settings.autoScroll) {
                requestAnimationFrame(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }
            
            return messageDiv;
        }
        
        // 设置消息事件监听器
        function setupMessageEventListeners(messageDiv, sender, messageId) {
            const isAI = sender === 'ai';
            
            // 复制按钮功能
            const copyBtns = messageDiv.querySelectorAll('.copy');
            copyBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const text = this.getAttribute('data-text');
                    navigator.clipboard.writeText(text).then(() => {
                        showNotification('已复制到剪贴板', 'success');
                        this.innerHTML = '<i class="fa fa-check"></i>已复制';
                        this.classList.add('bg-green-500/20');
                        setTimeout(() => {
                            this.innerHTML = '<i class="fa fa-copy"></i>' + (isAI ? '复制' : '复制');
                            this.classList.remove('bg-green-500/20');
                        }, 1000);
                    }).catch(err => {
                        console.error('复制失败:', err);
                        showNotification('复制失败', 'error');
                    });
                });
            });
            
            if (isAI) {
                // AI消息：重新生成按钮
                const regenerateBtn = messageDiv.querySelector('.regenerate');
                regenerateBtn.addEventListener('click', async function() {
                    const lastUserMessage = AppState.currentConversation
                        .filter(msg => msg.sender === 'user')
                        .pop();
                    
                    if (lastUserMessage) {
                        const messageElement = messageDiv.querySelector('.ai-bubble p');
                        const originalText = messageElement.textContent;
                        messageElement.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
                        
                        this.disabled = true;
                        this.innerHTML = '<i class="fa fa-refresh fa-spin"></i>重新生成中...';
                        
                        try {
                            let aiResponse;
                            if (AppState.settings.useAPI && GLM_CONFIG.apiKey) {
                                aiResponse = await generateAIResponse(lastUserMessage.content);
                            } else {
                                aiResponse = getFallbackResponse(lastUserMessage.content, AppState.settings.useAPI ? 'API未配置' : '');
                            }
                            
                            messageElement.textContent = aiResponse;
                            
                            const aiMessage = AppState.currentConversation.find(msg => 
                                msg.id === parseInt(messageId)
                            );
                            if (aiMessage) {
                                aiMessage.content = aiResponse;
                                aiMessage.timestamp = new Date();
                            }
                            
                            this.disabled = false;
                            this.innerHTML = '<i class="fa fa-refresh"></i>重新生成';
                            
                            const copyBtn = messageDiv.querySelector('.copy');
                            if (copyBtn) {
                                copyBtn.setAttribute('data-text', aiResponse);
                            }
                            
                            saveState();
                            showNotification('消息已重新生成', 'success');
                        } catch (error) {
                            messageElement.textContent = originalText;
                            this.disabled = false;
                            this.innerHTML = '<i class="fa fa-refresh"></i>重新生成';
                            showNotification('重新生成失败', 'error');
                        }
                    }
                });
                
                // AI消息：点赞/点踩功能
                const likeBtn = messageDiv.querySelector('[data-action="like"]');
                const dislikeBtn = messageDiv.querySelector('[data-action="dislike"]');
                
                likeBtn.addEventListener('click', function() {
                    const messageId = this.getAttribute('data-message-id');
                    const isLiked = this.classList.contains('liked');
                    
                    this.classList.toggle('liked');
                    dislikeBtn.classList.remove('disliked');
                    
                    AppState.messageFeedback[messageId] = {
                        liked: !isLiked,
                        disliked: false
                    };
                    
                    if (!isLiked) {
                        showNotification('感谢您的反馈！', 'success');
                    }
                    
                    saveState();
                });
                
                dislikeBtn.addEventListener('click', function() {
                    const messageId = this.getAttribute('data-message-id');
                    const isDisliked = this.classList.contains('disliked');
                    
                    this.classList.toggle('disliked');
                    likeBtn.classList.remove('liked');
                    
                    AppState.messageFeedback[messageId] = {
                        liked: false,
                        disliked: !isDisliked
                    };
                    
                    if (!isDisliked) {
                        showNotification('感谢您的反馈，我们会改进！', 'info');
                    }
                    
                    saveState();
                });
                
            } else {
                // 用户消息：编辑功能
                const editBtn = messageDiv.querySelector('.edit');
                const messageEditor = messageDiv.querySelector('.message-editor');
                const editInput = messageDiv.querySelector('.message-edit-input');
                const saveBtn = messageDiv.querySelector('.message-edit-btn.save');
                const cancelBtn = messageDiv.querySelector('.message-edit-btn.cancel');
                const messageText = messageDiv.querySelector('.user-bubble p');
                
                editBtn.addEventListener('click', function() {
                    messageEditor.style.display = 'block';
                    editInput.focus();
                    editInput.select();
                    
                    const originalContent = messageText.textContent;
                    editInput.dataset.original = originalContent;
                });
                
                saveBtn.addEventListener('click', async function() {
                    const editedText = editInput.value.trim();
                    if (!editedText || editedText === editInput.dataset.original) {
                        messageEditor.style.display = 'none';
                        return;
                    }
                    
                    messageText.textContent = editedText;
                    messageEditor.style.display = 'none';
                    
                    const messageIndex = AppState.currentConversation.findIndex(msg => 
                        msg.id === parseInt(messageId)
                    );
                    if (messageIndex !== -1) {
                        const originalMessage = AppState.currentConversation[messageIndex];
                        
                        AppState.editHistory.push({
                            messageId: messageId,
                            originalContent: originalMessage.content,
                            editedContent: editedText,
                            timestamp: new Date()
                        });
                        
                        originalMessage.content = editedText;
                        originalMessage.isEdited = true;
                        
                        const messagesToRemove = AppState.currentConversation.slice(messageIndex + 1);
                        AppState.currentConversation = AppState.currentConversation.slice(0, messageIndex + 1);
                        
                        messagesToRemove.forEach(msg => {
                            const msgElement = document.querySelector(`[data-message-id="${msg.id}"]`);
                            if (msgElement) {
                                msgElement.remove();
                            }
                        });
                        
                        showTypingIndicator();
                        
                        try {
                            let aiResponse;
                            if (AppState.settings.useAPI && GLM_CONFIG.apiKey) {
                                aiResponse = await generateAIResponse(editedText);
                            } else {
                                aiResponse = getFallbackResponse(editedText, AppState.settings.useAPI ? 'API未配置' : '');
                            }
                            
                            removeTypingIndicator();
                            const newAiMessageId = Date.now();
                            addMessage(aiResponse, 'ai', newAiMessageId);
                            
                            const aiMessage = {
                                id: newAiMessageId,
                                content: aiResponse,
                                sender: 'ai',
                                timestamp: new Date()
                            };
                            AppState.currentConversation.push(aiMessage);
                            
                            showNotification('消息已编辑并重新发送', 'success');
                            saveState();
                            
                        } catch (error) {
                            removeTypingIndicator();
                            console.error('重新生成响应失败:', error);
                            showNotification('重新生成响应失败', 'error');
                        }
                    }
                });
                
                cancelBtn.addEventListener('click', function() {
                    messageEditor.style.display = 'none';
                    editInput.value = editInput.dataset.original || messageText.textContent;
                });
                
                editInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        saveBtn.click();
                    } else if (e.key === 'Escape') {
                        cancelBtn.click();
                    }
                });
            }
        }
        
        // 显示AI正在输入
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'chat-bubble';
            typingDiv.innerHTML = `
                <div class="ai-bubble">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            requestAnimationFrame(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }
        
        // 移除正在输入指示器
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // 生成AI回复
        async function generateAIResponse(userMessage) {
            try {
                const messages = [
                    {
                        role: 'system',
                        content: AppState.settings.systemPrompt || PRESET_PROMPTS.default
                    }
                ];
                
                const recentMessages = AppState.currentConversation.slice(-6);
                recentMessages.forEach(msg => {
                    messages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    });
                });
                
                messages.push({
                    role: 'user',
                    content: userMessage
                });
                
                const apiKey = GLM_CONFIG.apiKey;
                
                if (!apiKey) {
                    throw new Error('API Key未配置');
                }
                
                const response = await fetch(GLM_CONFIG.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: GLM_CONFIG.model,
                        messages: messages,
                        max_tokens: GLM_CONFIG.maxTokens,
                        temperature: GLM_CONFIG.temperature,
                        stream: false
                    })
                });

                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
                
            } catch (error) {
                console.error('调用智谱API失败:', error);
                throw error;
            }
        }
        
        // 备用回复生成
        function getFallbackResponse(userMessage, errorMsg = '') {
            const lowerMessage = userMessage.toLowerCase();
            
            const knowledgeBase = {
                '加法|减法|乘法|除法|数学': [
                    '加法是将两个或多个数合并成一个总数的运算。例如：2 + 3 = 5。',
                    '减法是从一个数中减去另一个数的运算。例如：5 - 2 = 3。',
                    '乘法是重复加法的快捷方式。例如：3 × 4 = 3 + 3 + 3 + 3 = 12。',
                    '除法是将一个数分成若干等份的运算。例如：12 ÷ 3 = 4。'
                ],
                '地球|太阳|月亮|星星|天文': [
                    '地球是我们生活的行星，是太阳系中第三颗行星。',
                    '太阳是太阳系的中心恒星，为地球提供光和热。',
                    '月亮是地球的天然卫星，绕着地球公转。',
                    '星星是宇宙中的发光天体，有的自己发光（恒星），有的反射光（行星）。'
                ],
                '国家|城市|首都|地理': [
                    '中国是亚洲的一个国家，首都是北京。',
                    '美国是北美洲的一个国家，首都是华盛顿特区。',
                    '日本是亚洲的一个岛国，首都是东京。',
                    '法国是欧洲的一个国家，首都是巴黎。'
                ],
                '动物|植物|人体|生物': [
                    '哺乳动物是温血动物，用乳汁喂养幼崽，如猫、狗、人类。',
                    '植物通过光合作用制造食物，需要阳光、水和二氧化碳。',
                    '人体由多个系统组成，包括消化系统、呼吸系统、循环系统等。',
                    '细胞是生物体的基本结构和功能单位。'
                ],
                '历史|古代|近代|现代': [
                    '中国古代有四大发明：造纸术、印刷术、火药、指南针。',
                    '第一次世界大战发生在1914-1918年。',
                    '第二次世界大战发生在1939-1945年。',
                    '互联网在20世纪90年代开始普及。'
                ],
                '编程|代码|python|html|css': [
                    '编程是用计算机语言告诉计算机做什么的过程。',
                    'Python是一种流行的编程语言，适合初学者学习。',
                    'HTML是用于创建网页结构的标记语言。',
                    'CSS是用于设计网页样式的样式表语言。'
                ]
            };
            
            for (const [keyword, responses] of Object.entries(knowledgeBase)) {
                const keywords = keyword.split('|');
                if (keywords.some(kw => lowerMessage.includes(kw.toLowerCase()))) {
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    return randomResponse + (errorMsg ? `\n\n(当前使用本地知识库，API调用失败: ${errorMsg})` : '');
                }
            }
            
            const defaultResponses = [
                '这是一个很好的问题！不过作为基础问题助手，我主要回答各学科的基础知识。',
                '关于这个问题，我建议查阅相关教材或咨询专业人士获取更详细的信息。',
                '我主要专注于基础问题的解答，对于这个问题，你可以从以下几个方面了解：\n1. 基本概念\n2. 常见例子\n3. 实际应用',
                '这是一个有趣的问题！作为基础问题助手，我建议你先了解相关的基本原理和概念。'
            ];
            
            return defaultResponses[Math.floor(Math.random() * defaultResponses.length)] + 
                   (errorMsg ? `\n\n(注意：API暂时不可用: ${errorMsg})` : '');
        }
        
        // 渲染快捷指令
        function renderQuickCommands() {
            const desktopList = document.getElementById('quick-commands-list');
            const mobileList = document.getElementById('mobile-commands-list');
            
            if (desktopList) desktopList.innerHTML = '';
            if (mobileList) mobileList.innerHTML = '';
            
            QuickCommands.forEach(cmd => {
                const cardHTML = `
                    <div class="quick-command-card p-4 bg-slate-800/50 rounded-xl hover:bg-slate-700/50 transition-all cursor-pointer hover:scale-[1.02] active:scale-[0.98]" data-command="${cmd.command}">
                        <div class="flex items-center space-x-3 mb-2">
                            <i class="fa ${cmd.icon} text-xl ${cmd.color}"></i>
                            <h4 class="font-medium text-slate-200">${cmd.title}</h4>
                        </div>
                        <p class="text-sm text-slate-400">${cmd.description}</p>
                    </div>
                `;
                
                if (desktopList) desktopList.innerHTML += cardHTML;
                if (mobileList) mobileList.innerHTML += cardHTML;
            });
            
            document.querySelectorAll('.quick-command-card').forEach(card => {
                card.addEventListener('click', function() {
                    const command = this.getAttribute('data-command');
                    const messageInput = document.getElementById('message-input');
                    messageInput.value = command;
                    messageInput.dispatchEvent(new Event('input'));
                    messageInput.focus();
                    
                    const modal = document.getElementById('mobile-commands-modal');
                    if (!modal.classList.contains('hidden')) {
                        modal.classList.add('hidden');
                        document.body.style.overflow = '';
                    }
                });
            });
        }
        
        // 自动生成对话标题
        function generateConversationTitle(firstMessage) {
            const message = firstMessage.content || firstMessage;
            
            // 根据消息内容生成标题
            if (message.length > 50) {
                return message.substring(0, 47) + '...';
            }
            
            // 根据消息类型生成标题
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('写') && lowerMessage.includes('邮件')) {
                return '邮件撰写';
            } else if (lowerMessage.includes('python') || lowerMessage.includes('代码') || lowerMessage.includes('编程')) {
                return '编程问题';
            } else if (lowerMessage.includes('学习') || lowerMessage.includes('教学') || lowerMessage.includes('教育')) {
                return '学习指导';
            } else if (lowerMessage.includes('翻译')) {
                return '翻译任务';
            } else if (lowerMessage.includes('天气')) {
                return '天气查询';
            } else if (lowerMessage.includes('健身') || lowerMessage.includes('运动')) {
                return '健身计划';
            } else if (lowerMessage.includes('推荐') || lowerMessage.includes('建议')) {
                return '建议咨询';
            } else if (lowerMessage.includes('解释') || lowerMessage.includes('说明')) {
                return '概念解释';
            } else if (lowerMessage.includes('制定') || lowerMessage.includes('计划')) {
                return '计划制定';
            } else if (lowerMessage.includes('分析') || lowerMessage.includes('数据')) {
                return '数据分析';
            } else if (lowerMessage.includes('创意') || lowerMessage.includes('灵感')) {
                return '创意讨论';
            } else if (lowerMessage.includes('健康') || lowerMessage.includes('医疗')) {
                return '健康咨询';
            } else if (lowerMessage.includes('工作') || lowerMessage.includes('职业')) {
                return '工作相关';
            } else if (lowerMessage.includes('生活') || lowerMessage.includes('日常')) {
                return '生活咨询';
            } else if (lowerMessage.includes('项目') || lowerMessage.includes('管理')) {
                return '项目管理';
            }
            
            // 默认标题
            return 'AI对话';
        }
        
        // 开始新对话
        function startNewConversation() {
            if (AppState.currentConversation.length > 0) {
                const firstUserMessage = AppState.currentConversation.find(msg => msg.sender === 'user');
                const title = firstUserMessage ? generateConversationTitle(firstUserMessage) : 'AI对话';
                
                const conversation = {
                    id: currentConversationId || Date.now(),
                    title: title,
                    messages: [...AppState.currentConversation],
                    timestamp: new Date()
                };
                
                // 检查是否已存在相同ID的对话
                const existingIndex = AppState.conversations.findIndex(c => c.id === conversation.id);
                if (existingIndex !== -1) {
                    AppState.conversations[existingIndex] = conversation;
                } else {
                    AppState.conversations.unshift(conversation);
                }
            }
            
            // 生成新的对话ID
            currentConversationId = Date.now();
            
            AppState.currentConversation = [];
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = `
                <div class="chat-bubble">
                    <div class="ai-bubble">
                        <p class="text-sm">🎉 新的对话已开始！我是你的慧助手，有什么可以帮你的吗？</p>
                    </div>
                    <div class="message-time mt-2 flex items-center">
                        <i class="fa fa-clock-o text-xs mr-1"></i>
                        <span>刚刚</span>
                    </div>
                </div>
            `;
            
            // 更新聊天标题
            document.getElementById('current-chat-title').textContent = '慧助手';
            
            saveState();
            renderChatHistory();
            showNotification('已开始新对话', 'success');
        }
        
        // 渲染对话历史
        function renderChatHistory() {
            const historyContainer = document.getElementById('chat-history');
            if (!historyContainer) return;
            
            historyContainer.innerHTML = '';
            
            // 按时间倒序排列
            const sortedConversations = [...AppState.conversations].sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            
            sortedConversations.slice(0, 5).forEach(conv => {
                const time = new Date(conv.timestamp).toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const historyItem = document.createElement('div');
                historyItem.className = 'p-3 rounded-lg hover:bg-slate-700/50 cursor-pointer transition-colors';
                historyItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h5 class="text-sm font-medium text-slate-200 truncate">${conv.title}</h5>
                            <p class="text-xs text-slate-400 mt-1">${time}</p>
                        </div>
                        <button class="delete-history-btn ml-2 text-slate-500 hover:text-red-400">
                            <i class="fa fa-times text-xs"></i>
                        </button>
                    </div>
                `;
                
                historyItem.addEventListener('click', () => loadConversation(conv.id));
                historyContainer.appendChild(historyItem);
            });
            
            if (AppState.conversations.length === 0) {
                historyContainer.innerHTML = '<p class="text-sm text-slate-500 text-center py-4">暂无历史对话</p>';
            }
            
            // 添加删除按钮事件
            document.querySelectorAll('.delete-history-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const conversationElement = this.closest('[data-conversation-id]');
                    const conversationId = conversationElement ? parseInt(conversationElement.dataset.conversationId) : null;
                    
                    if (conversationId && confirm('确定要删除这个对话吗？')) {
                        deleteConversation(conversationId);
                    }
                });
            });
        }
        
        // 加载对话
        function loadConversation(conversationId) {
            const conversation = AppState.conversations.find(c => c.id === conversationId);
            if (!conversation) return;
            
            AppState.currentConversation = conversation.messages;
            currentConversationId = conversation.id;
            
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            
            conversation.messages.forEach(msg => {
                addMessage(msg.content, msg.sender, msg.id);
            });
            
            // 更新聊天标题
            document.getElementById('current-chat-title').textContent = conversation.title;
            
            saveState();
            renderChatHistory();
            showNotification('已加载对话', 'success');
        }
        
        // 删除对话
        function deleteConversation(conversationId) {
            AppState.conversations = AppState.conversations.filter(c => c.id !== conversationId);
            saveState();
            renderChatHistory();
            showNotification('对话已删除', 'success');
        }
        
        // 更新统计
        function updateStats() {
            const today = new Date().toDateString();
            
            if (AppState.stats.lastReset !== today) {
                AppState.stats.todayCount = 0;
                AppState.stats.lastReset = today;
            }
            
            AppState.stats.todayCount++;
            AppState.stats.weekCount = AppState.conversations.length;
            AppState.stats.totalCount = AppState.conversations.reduce((total, conv) => 
                total + conv.messages.filter(m => m.sender === 'user').length, 0);
            
            document.getElementById('today-count').textContent = AppState.stats.todayCount;
            document.getElementById('week-count').textContent = AppState.stats.weekCount;
            document.getElementById('total-count').textContent = AppState.stats.totalCount;
        }
        
        // 导出对话
        function exportConversation() {
            if (AppState.currentConversation.length === 0) {
                showNotification('当前没有对话可导出', 'warning');
                return;
            }
            
            const firstUserMessage = AppState.currentConversation.find(msg => msg.sender === 'user');
            const title = firstUserMessage ? generateConversationTitle(firstUserMessage) : 'AI对话';
            
            const exportData = {
                title: title,
                date: new Date().toLocaleString(),
                messages: AppState.currentConversation,
                settings: {
                    systemPrompt: AppState.settings.systemPrompt,
                    model: AppState.settings.model,
                    temperature: AppState.settings.temperature
                }
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
                type: 'application/json' 
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title}-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('对话已导出', 'success');
        }
        
        // 主题切换
        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            const themeIcon = document.querySelector('#theme-toggle i');
            
            if (isDark) {
                document.documentElement.classList.remove('dark');
                document.documentElement.classList.add('light');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
                AppState.settings.theme = 'light';
            } else {
                document.documentElement.classList.remove('light');
                document.documentElement.classList.add('dark');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                AppState.settings.theme = 'dark';
            }
            
            saveState();
        }
        
        // 显示通知
        function showNotification(message, type = 'info') {
            const notificationArea = document.getElementById('notification-area');
            const notification = document.createElement('div');
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            notification.className = `notification ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2`;
            notification.innerHTML = `
                <i class="fa ${icons[type]}"></i>
                <span>${message}</span>
            `;
            
            notificationArea.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(20px)';
                notification.style.transition = 'all 0.3s ease';
                
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
        
        // 创建粒子背景
        function createParticles() {
            const container = document.getElementById('particle-container');
            const particleCount = Math.min(Math.floor(window.innerWidth / 20), 50);
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const size = Math.random() * 8 + 2;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${Math.random() * 100}%`;
                const duration = Math.random() * 20 + 10;
                const delay = Math.random() * 5;
                particle.style.animationDuration = `${duration}s`;
                particle.style.animationDelay = `${delay}s`;
                particle.style.opacity = Math.random() * 0.3 + 0.1;
                container.appendChild(particle);
            }
        }
        
        // 保存状态到localStorage
        function saveState() {
            const state = {
                conversations: AppState.conversations,
                tasks: AppState.tasks,
                knowledge: AppState.knowledge,
                settings: AppState.settings,
                stats: AppState.stats,
                currentPage: currentPage,
                user: AppState.user,
                messageFeedback: AppState.messageFeedback,
                editHistory: AppState.editHistory,
                taskFilters: AppState.taskFilters,
                knowledgeFilters: AppState.knowledgeFilters,
                taskTags: AppState.taskTags,
                knowledgeTags: AppState.knowledgeTags,
                currentConversationId: currentConversationId
            };
            localStorage.setItem('aiAssistantState', JSON.stringify(state));
        }
        
        // 从localStorage加载状态
        function loadState() {
            const savedState = localStorage.getItem('aiAssistantState');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    AppState.conversations = state.conversations || [];
                    AppState.tasks = state.tasks || sampleTasks;
                    AppState.knowledge = state.knowledge || sampleKnowledge;
                    AppState.settings = { ...AppState.settings, ...state.settings };
                    AppState.stats = state.stats || AppState.stats;
                    AppState.messageFeedback = state.messageFeedback || {};
                    AppState.editHistory = state.editHistory || [];
                    AppState.taskFilters = state.taskFilters || AppState.taskFilters;
                    AppState.knowledgeFilters = state.knowledgeFilters || AppState.knowledgeFilters;
                    AppState.taskTags = state.taskTags || AppState.taskTags;
                    AppState.knowledgeTags = state.knowledgeTags || AppState.knowledgeTags;
                    currentConversationId = state.currentConversationId || null;
                    
                    // 更新用户信息
                    if (state.user) {
                        AppState.user = { ...AppState.user, ...state.user };
                    }
                    
                    if (state.currentPage && state.currentPage !== 'chat') {
                        setTimeout(() => {
                            if (typeof switchPage === 'function') {
                                switchPage(state.currentPage);
                            }
                        }, 100);
                    }
                    
                    if (state.settings) {
                        if (state.settings.apiKey) {
                            GLM_CONFIG.apiKey = state.settings.apiKey;
                        }
                        if (state.settings.model) {
                            GLM_CONFIG.model = state.settings.model;
                        }
                        if (state.settings.temperature) {
                            GLM_CONFIG.temperature = state.settings.temperature;
                        }
                    }
                    
                    renderChatHistory();
                    
                } catch (error) {
                    console.error('加载状态失败:', error);
                }
            }
        }
        
        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 窗口大小变化时重新调整
        let resizeTimer;
        window.addEventListener('resize', function() {
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.style.height = 'auto';
                const maxHeight = 150;
                messageInput.style.height = Math.min(messageInput.scrollHeight, maxHeight) + 'px';
            }
            
            // 防抖处理
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                // 确保侧边栏状态正确
                requestAnimationFrame(() => {
                    if (window.innerWidth < 769) {
                        document.getElementById('sidebar-container').style.display = 'none';
                    } else {
                        document.getElementById('sidebar-container').style.display = 'block';
                    }
                });
            }, 150);
        });
        
        // 页面可见性变化
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                document.title = '慧助手 - 您的数字伙伴';
                document.getElementById('status-text').innerHTML = 
                    '<span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>在线 • 准备就绪';
            }
        });
        
        // 防止离开页面时数据丢失
        window.addEventListener('beforeunload', function(e) {
            saveState();
        });
    </script>
</body>
</html>
